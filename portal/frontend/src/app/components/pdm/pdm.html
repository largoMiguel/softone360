<div class="pdm-container">
    <!-- HEADER -->
    <div class="page-header">
        <div class="header-content">
            <div class="header-info">
                <h2 class="page-title">
                    <i class="fas fa-file-excel"></i>
                    <span *ngIf="!archivoExcelCargado">Plan de Desarrollo Municipal (PDM)</span>
                    <span *ngIf="archivoExcelCargado && vistaActual === 'dashboard'">Seguimiento - PDM</span>
                    <span *ngIf="archivoExcelCargado && vistaActual === 'productos'">Productos - PDM</span>
                    <span *ngIf="archivoExcelCargado && vistaActual === 'detalle'">Detalle del Producto</span>
                    <span *ngIf="archivoExcelCargado && vistaActual === 'analisis-producto'">An√°lisis Detallado del Producto</span>
                    <span *ngIf="archivoExcelCargado && vistaActual === 'analytics'">An√°lisis y Dashboards - PDM</span>
                </h2>
                <p class="page-subtitle" *ngIf="!archivoExcelCargado">
                    Cargue un archivo Excel con las 5 hojas del Plan de Desarrollo Municipal
                </p>
            </div>
            <div class="header-actions">
                <button *ngIf="archivoExcelCargado && vistaActual === 'dashboard'" class="btn btn-success me-2" (click)="verAnalytics()">
                    <i class="fas fa-chart-pie"></i> Ver An√°lisis
                </button>
                <button *ngIf="archivoExcelCargado && vistaActual === 'detalle'" class="btn btn-primary me-2" (click)="abrirModalAnalisisProducto()">
                    <i class="fas fa-chart-line"></i> Ver An√°lisis Detallado
                </button>
                <button *ngIf="vistaActual !== 'dashboard' && archivoExcelCargado" class="btn btn-outline-secondary me-2" (click)="volver()">
                    <i class="fas fa-arrow-left"></i> Volver
                </button>
                <button *ngIf="archivoExcelCargado && vistaActual === 'dashboard'" class="btn btn-outline-info me-2" (click)="exportarExcel()" title="Exportar PDM completo a Excel">
                    <i class="fas fa-file-excel"></i> Exportar Excel
                </button>
                <label *ngIf="archivoExcelCargado && vistaActual === 'dashboard' && puedeCargarArchivosEjecucion()" class="btn btn-outline-success me-2" (click)="abrirModalEjecucion()" title="Cargar Excel de Ejecuci√≥n Presupuestal (Solo Admin)">
                    <i class="fas fa-file-invoice-dollar"></i> Cargar Ejecuci√≥n
                </label>
                <button *ngIf="archivoExcelCargado && (vistaActual === 'dashboard' || vistaActual === 'detalle') && puedeCargarArchivosEjecucion()" class="btn btn-outline-primary" (click)="cargarNuevoArchivo()" title="Cargar Nuevo Archivo (Solo Admin)">
                    <i class="fas fa-upload"></i> Cargar Nuevo Archivo
                </button>
            </div>
        </div>
    </div>

    <!-- LOADING -->
    <div *ngIf="cargando || cargandoDesdeBackend" class="loading-overlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-3 text-muted" *ngIf="cargando">Procesando archivo Excel...</p>
        <p class="mt-3 text-muted" *ngIf="cargandoDesdeBackend">Cargando datos desde el servidor...</p>
    </div>

    <!-- VISTA: CARGA DE ARCHIVO -->
    <div *ngIf="!archivoExcelCargado && !cargando && !cargandoDesdeBackend" class="vista-carga">
        <div class="card upload-card">
            <div class="card-body text-center p-5">
                <div class="upload-icon mb-4">
                    <i class="fas fa-cloud-upload-alt fa-5x text-primary"></i>
                </div>
                <h4 class="mb-3">Cargar Plan de Desarrollo Municipal</h4>
                <p class="text-muted mb-4">
                    Seleccione un archivo Excel (.xlsx o .xls) que contenga las siguientes hojas:
                </p>
                <ul class="list-unstyled text-start mb-4" style="max-width: 500px; margin: 0 auto;">
                    <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i> L√≠neas Estrat√©gicas</li>
                    <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i> Indicadores de Resultado</li>
                    <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i> Iniciativas SGR</li>
                    <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i> Plan Indicativo - Productos</li>
                    <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i> Plan Indicativo SGR - Productos</li>
                </ul>
                <label class="btn btn-primary btn-lg">
                    <i class="fas fa-file-excel me-2"></i> Seleccionar Archivo Excel
                    <input type="file" accept=".xlsx,.xls" (change)="onFileSelected($event)" style="display: none;">
                </label>
            </div>
        </div>
    </div>

    <!-- VISTA: DASHBOARD -->
    <div *ngIf="archivoExcelCargado && vistaActual === 'dashboard' && estadisticas" class="vista-dashboard">
        <!-- Estad√≠sticas Generales -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="stat-card card clickable" (click)="filtrarPorLinea()" title="Filtrar por l√≠neas estrat√©gicas">
                    <div class="card-body">
                        <div class="stat-icon">
                            <i class="fas fa-layer-group fa-2x text-primary"></i>
                        </div>
                        <div class="stat-info">
                            <h3 class="stat-value">{{ estadisticas.total_lineas_estrategicas }}</h3>
                            <p class="stat-label">L√≠neas Estrat√©gicas</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card card clickable" (click)="navegarA('productos')" title="Ver todos los productos">
                    <div class="card-body">
                        <div class="stat-icon">
                            <i class="fas fa-box fa-2x text-info"></i>
                        </div>
                        <div class="stat-info">
                            <h3 class="stat-value">{{ estadisticas.total_productos }}</h3>
                            <p class="stat-label">Productos</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card card clickable" (click)="filtrarPorIniciativa()" title="Filtrar por iniciativas SGR">
                    <div class="card-body">
                        <div class="stat-icon">
                            <i class="fas fa-project-diagram fa-2x text-warning"></i>
                        </div>
                        <div class="stat-info">
                            <h3 class="stat-value">{{ estadisticas.total_iniciativas_sgr }}</h3>
                            <p class="stat-label">Iniciativas SGR</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card card clickable" (click)="verAnalytics()" title="Ver an√°lisis completo">
                    <div class="card-body">
                        <div class="stat-icon">
                            <i class="fas fa-dollar-sign fa-2x text-success"></i>
                        </div>
                        <div class="stat-info">
                            <h3 class="stat-value-small">{{ formatearMoneda(estadisticas.presupuesto_total) }}</h3>
                            <p class="stat-label">Presupuesto Total</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Presupuesto por A√±o -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i> Presupuesto por A√±o (Cuatrienio)</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <div class="year-budget">
                            <h6 class="text-muted mb-2">2024</h6>
                            <h4 class="text-primary">{{ formatearMoneda(estadisticas.presupuestoPorAnio.anio2024) }}</h4>
                            <div class="progress mt-2" style="height: 6px;">
                                <div class="progress-bar bg-primary" [style.width.%]="(estadisticas.presupuestoPorAnio.anio2024 / estadisticas.presupuesto_total) * 100"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="year-budget">
                            <h6 class="text-muted mb-2">2025</h6>
                            <h4 class="text-info">{{ formatearMoneda(estadisticas.presupuestoPorAnio.anio2025) }}</h4>
                            <div class="progress mt-2" style="height: 6px;">
                                <div class="progress-bar bg-info" [style.width.%]="(estadisticas.presupuestoPorAnio.anio2025 / estadisticas.presupuesto_total) * 100"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="year-budget">
                            <h6 class="text-muted mb-2">2026</h6>
                            <h4 class="text-warning">{{ formatearMoneda(estadisticas.presupuestoPorAnio.anio2026) }}</h4>
                            <div class="progress mt-2" style="height: 6px;">
                                <div class="progress-bar bg-warning" [style.width.%]="(estadisticas.presupuestoPorAnio.anio2026 / estadisticas.presupuesto_total) * 100"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="year-budget">
                            <h6 class="text-muted mb-2">2027</h6>
                            <h4 class="text-success">{{ formatearMoneda(estadisticas.presupuestoPorAnio.anio2027) }}</h4>
                            <div class="progress mt-2" style="height: 6px;">
                                <div class="progress-bar bg-success" [style.width.%]="(estadisticas.presupuestoPorAnio.anio2027 / estadisticas.presupuesto_total) * 100"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Presupuesto por L√≠nea Estrat√©gica -->
        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i> Presupuesto por L√≠nea Estrat√©gica</h5>
                    </div>
                    <div class="card-body">
                        <div *ngFor="let item of estadisticas.presupuesto_por_linea" class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <small class="text-truncate" style="max-width: 60%;" [title]="item.linea">{{ item.linea }}</small>
                                <small class="fw-bold">{{ formatearMoneda(item.total) }}</small>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-primary" 
                                     [style.width.%]="(item.total / estadisticas.presupuesto_total) * 100"
                                     [title]="((item.total / estadisticas.presupuesto_total) * 100).toFixed(1) + '%'">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Presupuesto por Sector -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i> Presupuesto por Sector</h5>
                    </div>
                    <div class="card-body">
                        <div *ngFor="let item of estadisticas.presupuesto_por_sector.slice(0, 10)" class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <small class="text-truncate" style="max-width: 60%;" [title]="item.sector">{{ item.sector }}</small>
                                <small class="fw-bold">{{ formatearMoneda(item.total) }}</small>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-success" 
                                     [style.width.%]="(item.total / estadisticas.presupuesto_total) * 100"
                                     [title]="((item.total / estadisticas.presupuesto_total) * 100).toFixed(1) + '%'">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ‚úÖ NUEVO: Mostrar tabla filtrada en dashboard cuando se hace clic en cards de estado -->
        <div *ngIf="filtroEstado" class="card mb-4 border-info">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-filter me-2"></i>
                    Productos {{ filtroEstado === 'PENDIENTE' ? 'Pendientes' : 
                                 filtroEstado === 'EN_PROGRESO' ? 'En Progreso' : 
                                 filtroEstado === 'COMPLETADO' ? 'Completados' : 
                                 'Por Ejecutar' }}
                </h5>
                <button class="btn btn-sm btn-light" (click)="limpiarFiltroEstado()">
                    <i class="fas fa-times me-1"></i> Cerrar
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>C√≥digo</th>
                                <th>Producto</th>
                                <th>L√≠nea</th>
                                <th>Sector</th>
                                <th>Meta 2024</th>
                                <th>Avance</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let p of productosFiltradosCache">
                                <td><small class="fw-bold">{{ p.codigo }}</small></td>
                                <td><small>{{ p.producto | slice:0:30 }}</small></td>
                                <td><small>{{ p.linea_estrategica | slice:0:20 }}</small></td>
                                <td><small>{{ p.sector | slice:0:20 }}</small></td>
                                <td class="text-center"><small class="fw-bold">{{ p.meta_cuatrienio }}</small></td>
                                <td class="text-center">
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar" 
                                             [style.width.%]="p.porcentaje_ejecucion"
                                             [ngClass]="{
                                                'bg-success': p.porcentaje_ejecucion === 100,
                                                'bg-info': p.porcentaje_ejecucion > 0 && p.porcentaje_ejecucion < 100,
                                                'bg-warning': p.porcentaje_ejecucion === 0
                                             }">
                                            <small>{{ p.porcentaje_ejecucion }}%</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge" 
                                          [ngClass]="{
                                              'bg-warning': getEstadoProductoAnio(p, filtroAnio) === 'PENDIENTE',
                                              'bg-info': getEstadoProductoAnio(p, filtroAnio) === 'EN_PROGRESO',
                                              'bg-success': getEstadoProductoAnio(p, filtroAnio) === 'COMPLETADO',
                                              'bg-secondary': getEstadoProductoAnio(p, filtroAnio) === 'POR_EJECUTAR'
                                          }">
                                        {{ getEstadoProductoAnio(p, filtroAnio) === 'PENDIENTE' ? 'Pendiente' : 
                                           getEstadoProductoAnio(p, filtroAnio) === 'EN_PROGRESO' ? 'En Progreso' : 
                                           getEstadoProductoAnio(p, filtroAnio) === 'COMPLETADO' ? 'Completado' : 
                                           'Por Ejecutar' }}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" (click)="verAnalisisProducto(p)">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <p *ngIf="getProductosFiltrados().length === 0" class="text-muted text-center mt-3">
                    No hay productos con este estado
                </p>
            </div>
        </div>

        <!-- Bot√≥n para ver productos -->
        <div class="text-center mb-4">
            <button class="btn btn-primary btn-lg" (click)="navegarA('productos')">
                <i class="fas fa-list me-2"></i> Ver Todos los Productos
            </button>
        </div>
    </div>

    <!-- VISTA: PRODUCTOS -->
    <div *ngIf="archivoExcelCargado && vistaActual === 'productos'" class="vista-productos">
        <!-- Selector de A√±o -->
        <div class="card mb-4 bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i> A√±o de Seguimiento</h5>
                    <div class="btn-group" role="group">
                        <button *ngFor="let anio of aniosDisponibles" 
                                type="button" 
                                class="btn"
                                [class.btn-light]="filtroAnio === anio"
                                [class.btn-outline-light]="filtroAnio !== anio"
                                (click)="cambiarAnioFiltro(anio)">
                            {{ anio }}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard de Estad√≠sticas por Estado (Solo productos con meta > 0 para el a√±o seleccionado) -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="stat-card card border-warning clickable" (click)="filtrarPorEstadoPendiente()" title="Filtrar productos pendientes">
                    <div class="card-body">
                        <div class="stat-icon">
                            <i class="fas fa-clock fa-2x text-warning"></i>
                        </div>
                        <div class="stat-info">
                            <h3 class="stat-value">{{ estadisticasPorEstadoCache.pendiente }}</h3>
                            <p class="stat-label">Pendientes</p>
                            <small class="text-muted">Sin avance en {{ filtroAnio }}</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card card border-info clickable" (click)="filtrarPorEstadoEnProgreso()" title="Filtrar productos en progreso">
                    <div class="card-body">
                        <div class="stat-icon">
                            <i class="fas fa-spinner fa-2x text-info"></i>
                        </div>
                        <div class="stat-info">
                            <h3 class="stat-value">{{ estadisticasPorEstadoCache.en_progreso }}</h3>
                            <p class="stat-label">En Progreso</p>
                            <small class="text-muted">Con actividades en {{ filtroAnio }}</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card card border-success clickable" (click)="filtrarPorEstadoCompletado()" title="Filtrar productos completados">
                    <div class="card-body">
                        <div class="stat-icon">
                            <i class="fas fa-check-circle fa-2x text-success"></i>
                        </div>
                        <div class="stat-info">
                            <h3 class="stat-value">{{ estadisticasPorEstadoCache.completado }}</h3>
                            <p class="stat-label">Completados</p>
                            <small class="text-muted">100% de avance en {{ filtroAnio }}</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card card border-secondary clickable" (click)="filtrarPorEstadoPorEjecutar()" title="Filtrar productos por ejecutar">
                    <div class="card-body">
                        <div class="stat-icon">
                            <i class="fas fa-calendar-plus fa-2x text-secondary"></i>
                        </div>
                        <div class="stat-info">
                            <h3 class="stat-value">{{ estadisticasPorEstadoCache.por_ejecutar }}</h3>
                            <p class="stat-label">Por Ejecutar</p>
                            <small class="text-muted">Programados para {{ filtroAnio }}</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label"><i class="fas fa-layer-group me-1"></i> L√≠nea Estrat√©gica</label>
                        <select class="form-select" [(ngModel)]="filtroLinea" (change)="onCambioFiltroLinea()">
                            <option value="">Todas las l√≠neas</option>
                            <option *ngFor="let linea of lineasEstrategicas" [value]="linea">{{ linea }}</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label"><i class="fas fa-industry me-1"></i> Sector</label>
                        <select class="form-select" [(ngModel)]="filtroSector" (change)="onCambioFiltroSector()">
                            <option value="">Todos los sectores</option>
                            <option *ngFor="let sector of sectores" [value]="sector">{{ sector }}</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label"><i class="fas fa-building me-1"></i> Secretar√≠a Responsable</label>
                        <select class="form-select" [(ngModel)]="filtroSecretaria" (change)="onCambioFiltro()">
                            <option value="">Todas las secretar√≠as</option>
                            <option *ngFor="let secretaria of secretariasAgrupadas" [value]="secretaria.id">
                                üè¢ {{ secretaria.nombre }}
                            </option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label"><i class="fas fa-globe me-1"></i> ODS</label>
                        <select class="form-select" [(ngModel)]="filtroODS" (change)="onCambioFiltro()">
                            <option value="">Todos los ODS</option>
                            <option *ngFor="let ods of odsDisponibles" [value]="ods">{{ ods }}</option>
                        </select>
                    </div>
                </div>
                <div class="row g-3 mt-2">
                    <div class="col-md-3">
                        <label class="form-label"><i class="fas fa-code-branch me-1"></i> Tipo Acumulaci√≥n</label>
                        <select class="form-select" [(ngModel)]="filtroTipoAcumulacion" (change)="onCambioFiltro()">
                            <option value="">Todos los tipos</option>
                            <option *ngFor="let tipo of tiposAcumulacionDisponibles" [value]="tipo">{{ tipo }}</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label"><i class="fas fa-calendar-alt me-1"></i> A√±o</label>
                        <select class="form-select" [(ngModel)]="filtroAnio" (change)="onCambioFiltro()">
                            <option *ngFor="let anio of aniosDisponibles" [value]="anio">{{ anio }}</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label"><i class="fas fa-circle-notch me-1"></i> Estado</label>
                        <select class="form-select" [(ngModel)]="filtroEstado" (change)="onCambioFiltro()">
                            <option value="">Todos los estados</option>
                            <option value="PENDIENTE">Pendiente</option>
                            <option value="EN_PROGRESO">En Progreso</option>
                            <option value="COMPLETADO">Completado</option>
                            <option value="POR_EJECUTAR">Por Ejecutar</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label"><i class="fas fa-search me-1"></i> Buscar Producto</label>
                        <input type="text" class="form-control" [(ngModel)]="filtroBusqueda" (keyup)="onCambioFiltroBusqueda()" placeholder="Buscar por c√≥digo, nombre...">
                    </div>
                </div>
                <div class="mt-3 d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Mostrando <strong>{{ productosFiltrados.length }}</strong> de <strong>{{ resumenProductos.length }}</strong> productos para el a√±o <strong>{{ filtroAnio }}</strong>
                    </small>
                    <button class="btn btn-sm btn-outline-secondary" (click)="limpiarFiltros()">
                        <i class="fas fa-times me-1"></i> Limpiar Filtros
                    </button>
                </div>
            </div>
        </div>

        <!-- Tabla de Productos -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-box me-2"></i> Productos del Plan Indicativo - A√±o {{ filtroAnio }}
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 productos-table">
                        <thead>
                            <tr>
                                <th style="width: 100px;">C√≥digo</th>
                                <th>Producto</th>
                                <th style="width: 120px;">Meta Cuatrienio</th>
                                <th style="width: 130px;">Meta {{ filtroAnio }}</th>
                                <th style="width: 140px;">Presupuesto</th>
                                <th style="width: 140px;">Avance</th>
                                <th style="width: 120px;">Estado</th>
                                <th style="width: 200px;">Responsable</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngIf="productosFiltrados.length === 0">
                                <td colspan="8" class="text-center py-4">
                                    <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                                    <p class="text-muted">No se encontraron productos con los filtros seleccionados</p>
                                </td>
                            </tr>
                            <tr *ngFor="let producto of productosFiltrados" class="cursor-pointer" (click)="navegarA('detalle', producto)">
                                <td><span class="badge bg-secondary">{{ producto.codigo }}</span></td>
                                <td>
                                    <div class="producto-info">
                                        <strong>{{ producto.producto }}</strong>
                                        <small class="d-block text-muted">{{ producto.sector }}</small>
                                        <small class="d-block text-muted">{{ producto.linea_estrategica }}</small>
                                    </div>
                                </td>
                                <td class="text-center">
                                    <strong>{{ formatearNumero(producto.meta_cuatrienio) }}</strong>
                                    <small class="d-block text-muted">{{ producto.unidad_medida }}</small>
                                </td>
                                <td class="text-center">
                                    <strong>{{ formatearNumero(getMetaAnio(producto, filtroAnio)) }}</strong>
                                    <small class="d-block text-muted">{{ producto.unidad_medida }}</small>
                                </td>
                                <td class="text-end">
                                    <strong class="text-success">{{ formatearMoneda(getPresupuestoAnio(producto, filtroAnio)) }}</strong>
                                </td>
                                <td class="text-center">
                                    <div class="progress" style="height: 24px;">
                                        <div [class]="'progress-bar ' + getColorProgreso(getAvanceAnio(producto, filtroAnio))" 
                                             [style.width.%]="getAvanceAnio(producto, filtroAnio)"
                                             role="progressbar">
                                            <strong>{{ getAvanceAnio(producto, filtroAnio).toFixed(1) }}%</strong>
                                        </div>
                                    </div>
                                </td>
                                <td class="text-center">
                                    <span class="badge" [class]="'bg-' + getColorEstadoProducto(getEstadoProductoAnio(producto, filtroAnio))">
                                        {{ getTextoEstadoProducto(getEstadoProductoAnio(producto, filtroAnio)) }}
                                    </span>
                                </td>
                                <td (click)="$event.stopPropagation()">
                                    <!-- Dropdown de asignaci√≥n de SECRETAR√çA solo para Admin -->
                                    <select 
                                        *ngIf="isAdmin()"
                                        class="form-select form-select-sm" 
                                        [value]="producto.responsable_secretaria_id || ''"
                                        (change)="asignarResponsable(producto, $event)"
                                        [disabled]="cargandoSecretarios">
                                        <option value="">Asignar secretar√≠a responsable...</option>
                                        <option *ngFor="let secretaria of secretariasAgrupadas" 
                                                [value]="secretaria.id"
                                                [title]="'ID: ' + secretaria.id">
                                            üè¢ {{ secretaria.nombre }} ({{ secretaria.responsables?.length || 0 }} usuario(s))
                                        </option>
                                    </select>
                                    
                                    <!-- Mostrar nombre de SECRETAR√çA responsable (no usuario) -->
                                    <small *ngIf="!isAdmin() && producto.responsable_secretaria_nombre" class="text-muted d-block">
                                        <i class="fas fa-building me-1"></i>{{ producto.responsable_secretaria_nombre }}
                                    </small>
                                    <small *ngIf="producto.responsable_secretaria_nombre && isAdmin()" class="text-muted d-block mt-1">
                                        <i class="fas fa-building me-1"></i>{{ producto.responsable_secretaria_nombre }}
                                    </small>
                                    <small *ngIf="cargandoSecretarios" class="text-muted d-block mt-1">
                                        <i class="fas fa-spinner fa-spin"></i> Cargando...
                                    </small>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- VISTA: DETALLE PRODUCTO -->
    <div *ngIf="archivoExcelCargado && vistaActual === 'detalle' && productoSeleccionado" class="vista-detalle">
        <div class="row">
            <!-- Informaci√≥n Principal -->
            <div class="col-lg-8 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i> Informaci√≥n del Producto</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="text-muted small">C√≥digo Producto</label>
                                <p class="fw-bold">{{ productoSeleccionado.codigo }}</p>
                            </div>
                            <div class="col-md-6">
                                <label class="text-muted small">Unidad de Medida</label>
                                <p class="fw-bold">{{ productoSeleccionado.unidad_medida }}</p>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="text-muted small">Producto (MGA)</label>
                                <p class="fw-bold">{{ productoSeleccionado.producto_mga || productoSeleccionado.detalle_completo?.producto_mga || 'N/D' }}</p>
                            </div>
                            <div class="col-md-6">
                                <label class="text-muted small">Indicador de Producto (MGA)</label>
                                <p class="fw-bold">{{ productoSeleccionado.indicador_producto_mga || productoSeleccionado.detalle_completo?.indicador_producto_mga || 'N/D' }}</p>
                            </div>
                        </div>

                        <!-- C√≥digo Indicador (SisPT) -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="text-muted small">C√≥digo Indicador (SisPT)</label>
                                <p class="fw-bold">{{ productoSeleccionado.detalle_completo?.codigo_indicador_producto || 'N/A' }}</p>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="text-muted small">L√≠nea Estrat√©gica</label>
                                <p>{{ productoSeleccionado.linea_estrategica }}</p>
                            </div>
                            <div class="col-md-4">
                                <label class="text-muted small">Sector MGA</label>
                                <p>{{ productoSeleccionado.sector }}</p>
                            </div>
                            <div class="col-md-4">
                                <label class="text-muted small">Programa MGA</label>
                                <p>{{ productoSeleccionado.programa_mga || 'N/A' }}</p>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="text-muted small">ODS</label>
                                <p><span class="badge bg-info">{{ productoSeleccionado.ods || 'N/A' }}</span></p>
                            </div>
                            <div class="col-md-4">
                                <label class="text-muted small">Tipo de Acumulaci√≥n</label>
                                <p>{{ productoSeleccionado.tipo_acumulacion || 'N/A' }}</p>
                            </div>
                            <div class="col-md-4">
                                <label class="text-muted small">BPIN</label>
                                <p *ngIf="productoSeleccionado.bpin && productoSeleccionado.bpin.trim() !== ''">
                                    <a href="javascript:void(0)" (click)="abrirModalBPIN(productoSeleccionado.bpin)" class="text-primary fw-bold">
                                        <i class="fas fa-external-link-alt me-1"></i>{{ productoSeleccionado.bpin }}
                                    </a>
                                </p>
                                <p *ngIf="!productoSeleccionado.bpin || productoSeleccionado.bpin.trim() === ''">N/A</p>
                            </div>
                        </div>

                        <hr>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="text-muted small">Meta Cuatrienio</label>
                                <h4 class="text-primary">{{ formatearNumero(productoSeleccionado.meta_cuatrienio) }}</h4>
                                <small class="text-muted">{{ productoSeleccionado.unidad_medida }}</small>
                            </div>
                            <div class="col-md-4">
                                <label class="text-muted small">Metas Programadas</label>
                                <h4 class="text-info">{{ getAniosConMetas(productoSeleccionado) }}</h4>
                                <small class="text-muted">a√±os con metas</small>
                            </div>
                            <div class="col-md-4">
                                <label class="text-muted small">% de Avance</label>
                                <h4 [class]="'text-' + (productoSeleccionado.porcentaje_ejecucion >= 75 ? 'success' : productoSeleccionado.porcentaje_ejecucion >= 50 ? 'warning' : 'danger')">
                                    {{ productoSeleccionado.porcentaje_ejecucion.toFixed(1) }}%
                                </h4>
                            </div>
                        </div>

                        <div class="progress mb-3" style="height: 25px;">
                            <div [class]="'progress-bar ' + getColorProgreso(productoSeleccionado.porcentaje_ejecucion)" 
                                 [style.width.%]="productoSeleccionado.porcentaje_ejecucion"
                                 role="progressbar">
                                <strong>{{ productoSeleccionado.porcentaje_ejecucion.toFixed(1) }}%</strong>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gesti√≥n de Actividades por A√±o -->
                <div class="card mt-4">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-tasks me-2"></i> Actividades y Seguimiento</h5>
                            <div class="d-flex align-items-center gap-2">
                                <!-- ‚úÖ Indicador de carga -->
                                <div *ngIf="cargandoActividadesBackend" class="d-flex align-items-center text-muted small">
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                    <small>Cargando datos del servidor...</small>
                                </div>
                                <button class="btn btn-sm btn-primary" (click)="abrirModalNuevaActividad()" [disabled]="cargandoActividadesBackend" *ngIf="puedeCrearEvidenciaCache && resumenAnioActual && resumenAnioActual.meta_disponible > 0">
                                    <i class="fas fa-plus me-1"></i> Nueva Evidencia de Ejecuci√≥n
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Tabs de A√±os -->
                        <ul class="nav nav-tabs mb-3">
                            <li class="nav-item">
                                <a class="nav-link" [class.active]="anioSeleccionado === 2024" (click)="seleccionarAnio(2024)" style="cursor: pointer;">
                                    2024
                                    <span *ngIf="avanceProducto" class="badge bg-primary ms-1">{{ avanceProducto.avance_por_anio[2024].porcentaje_avance.toFixed(0) }}%</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" [class.active]="anioSeleccionado === 2025" (click)="seleccionarAnio(2025)" style="cursor: pointer;">
                                    2025
                                    <span *ngIf="avanceProducto" class="badge bg-info ms-1">{{ avanceProducto.avance_por_anio[2025].porcentaje_avance.toFixed(0) }}%</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" [class.active]="anioSeleccionado === 2026" (click)="seleccionarAnio(2026)" style="cursor: pointer;">
                                    2026
                                    <span *ngIf="avanceProducto" class="badge bg-warning ms-1">{{ avanceProducto.avance_por_anio[2026].porcentaje_avance.toFixed(0) }}%</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" [class.active]="anioSeleccionado === 2027" (click)="seleccionarAnio(2027)" style="cursor: pointer;">
                                    2027
                                    <span *ngIf="avanceProducto" class="badge bg-success ms-1">{{ avanceProducto.avance_por_anio[2027].porcentaje_avance.toFixed(0) }}%</span>
                                </a>
                            </li>
                        </ul>

                        <!-- ‚úÖ Indicador de carga mientras se sincronizan actividades -->
                        <div *ngIf="cargandoActividadesBackend" class="alert alert-info mb-3 text-center">
                            <div class="spinner-border spinner-border-sm me-2"></div>
                            <strong>Cargando actividades desde el servidor...</strong>
                        </div>

                        <!-- Resumen del A√±o Seleccionado -->
                        <div *ngIf="resumenAnioActual" class="alert alert-info mb-3">
                            <div class="row text-center">
                                <div class="col-md-3">
                                    <strong>Meta Programada</strong>
                                    <p class="mb-0">{{ formatearNumero(resumenAnioActual.meta_programada) }} {{ productoSeleccionado.unidad_medida }}</p>
                                </div>
                                <div class="col-md-3">
                                    <strong>Meta Asignada</strong>
                                    <p class="mb-0">{{ formatearNumero(resumenAnioActual.meta_asignada) }} {{ productoSeleccionado.unidad_medida }}</p>
                                </div>
                                <div class="col-md-3">
                                    <strong>Meta Disponible</strong>
                                    <p class="mb-0" [class.text-danger]="resumenAnioActual.meta_disponible === 0">
                                        {{ formatearNumero(resumenAnioActual.meta_disponible) }} {{ productoSeleccionado.unidad_medida }}
                                    </p>
                                </div>
                                <div class="col-md-3">
                                    <strong>Avance del A√±o</strong>
                                    <p class="mb-0">
                                        {{ resumenAnioActual.actividades_completadas }} / {{ resumenAnioActual.total_actividades }} evidencias
                                        <span class="badge" [class]="'bg-' + getColorProgreso(resumenAnioActual.porcentaje_avance) + ' ms-1'">
                                            {{ resumenAnioActual.porcentaje_avance.toFixed(1) }}%
                                        </span>
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Lista de Actividades -->
                        <div *ngIf="resumenAnioActual">
                            <div *ngIf="resumenAnioActual.actividades.length === 0" class="text-center py-4 text-muted">
                                <i class="fas fa-inbox fa-3x mb-3"></i>
                                <p>No hay actividades registradas para este a√±o.</p>
                                <button *ngIf="isAdmin() && resumenAnioActual.meta_disponible > 0" class="btn btn-primary" (click)="abrirModalNuevaActividad()">
                                    <i class="fas fa-plus me-1"></i> Crear Primera Actividad
                                </button>
                                <div *ngIf="resumenAnioActual.meta_disponible === 0" class="alert alert-warning mt-3">
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    No hay meta disponible para crear actividades en este a√±o.
                                </div>
                            </div>

                            <div *ngIf="resumenAnioActual.actividades.length > 0" class="actividades-list">
                                <div *ngFor="let actividad of resumenAnioActual.actividades" class="card mb-3 actividad-card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1">
                                                    {{ actividad.nombre }}
                                                    <span class="badge ms-2" [class]="'bg-' + getColorEstado(actividad.estado)">
                                                        {{ getTextoEstado(actividad.estado) }}
                                                    </span>
                                                    <span *ngIf="actividad.evidencia" class="badge bg-success ms-1">
                                                        <i class="fas fa-check-circle me-1"></i> Con Evidencia
                                                    </span>
                                                </h6>
                                                <p class="text-muted small mb-2">{{ actividad.descripcion }}</p>
                                                <div class="row small">
                                                    <div class="col-md-4">
                                                        <i class="fas fa-user me-1"></i> <strong>Responsable:</strong> {{ getNombreResponsable(actividad) }}
                                                    </div>
                                                    <div class="col-md-4">
                                                        <i class="fas fa-calendar me-1"></i> <strong>Fechas:</strong> {{ actividad.fecha_inicio | date:'dd/MM/yyyy':'America/Bogota':'es-CO' }} - {{ actividad.fecha_fin | date:'dd/MM/yyyy':'America/Bogota':'es-CO' }}
                                                    </div>
                                                    <div class="col-md-4">
                                                        <i class="fas fa-target me-1"></i> <strong>Meta:</strong> {{ formatearNumero(actividad.meta_ejecutar) }} {{ productoSeleccionado.unidad_medida }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="ms-3">
                                                <!-- Bot√≥n Editar evidencia -->
                                                <button *ngIf="puedeCrearEvidenciaCache && (!actividad.evidencia || isAdmin())" 
                                                        class="btn btn-sm btn-outline-primary me-1" 
                                                        (click)="abrirModalEditarActividad(actividad)" 
                                                        [title]="actividad.evidencia ? 'Editar Evidencia (Admin)' : 'Agregar Evidencia'">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button *ngIf="!actividad.evidencia || isAdmin()" class="btn btn-sm btn-outline-danger" (click)="eliminarActividad(actividad)" [title]="actividad.evidencia ? 'Eliminar (Admin - incluye evidencia)' : 'Eliminar'">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Mostrar Evidencia si existe -->
                                        <div *ngIf="actividad.evidencia" class="mt-3 p-3 bg-light rounded">
                                            <h6 class="text-success"><i class="fas fa-check-circle me-1"></i> Evidencia de Cumplimiento</h6>
                                            <!-- Mostrar descripci√≥n de evidencia solo si difiere de la de la actividad -->
                                            <p class="mb-2" *ngIf="actividad.evidencia.descripcion && actividad.evidencia.descripcion.trim().toLowerCase() !== actividad.descripcion.trim().toLowerCase()">
                                                <strong>Descripci√≥n evidencia:</strong> {{ actividad.evidencia.descripcion }}
                                            </p>
                                            <p class="mb-2 small text-muted">
                                                <i class="fas fa-clock me-1"></i> Registrado el {{ actividad.evidencia.fecha_registro | date:'dd/MM/yyyy HH:mm':'America/Bogota':'es-CO' }}
                                            </p>
                                            <div *ngIf="actividad.evidencia.url_evidencia" class="mb-2">
                                                <a [href]="actividad.evidencia.url_evidencia" target="_blank" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-external-link-alt me-1"></i> Ver Evidencia Externa
                                                </a>
                                            </div>
                                            <div *ngIf="actividad.evidencia.imagenes && actividad.evidencia.imagenes.length > 0" class="row">
                                                <div *ngFor="let imagen of actividad.evidencia.imagenes" class="col-md-3 mb-2">
                                                    <img [src]="imagen" class="img-thumbnail" style="cursor: pointer;" (click)="verImagenGrande(imagen)">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Informaci√≥n Adicional -->
            <div class="col-lg-4 mb-4">
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-chart-pie me-2"></i> Resumen Presupuestal</h6>
                    </div>
                    <div class="card-body">
                        <div class="budget-summary-item">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Presupuesto Total</span>
                                <strong class="text-success">{{ formatearMoneda(productoSeleccionado.total_cuatrienio) }}</strong>
                            </div>
                        </div>
                        <hr>
                        <div class="budget-summary-item mb-2">
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">2024</small>
                                <small>{{ formatearMoneda(productoSeleccionado.total_2024) }}</small>
                            </div>
                            <div class="progress mt-1" style="height: 4px;">
                                <div class="progress-bar bg-primary" [style.width.%]="(productoSeleccionado.total_2024 / productoSeleccionado.total_cuatrienio) * 100"></div>
                            </div>
                        </div>
                        <div class="budget-summary-item mb-2">
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">2025</small>
                                <small>{{ formatearMoneda(productoSeleccionado.total_2025) }}</small>
                            </div>
                            <div class="progress mt-1" style="height: 4px;">
                                <div class="progress-bar bg-info" [style.width.%]="(productoSeleccionado.total_2025 / productoSeleccionado.total_cuatrienio) * 100"></div>
                            </div>
                        </div>
                        <div class="budget-summary-item mb-2">
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">2026</small>
                                <small>{{ formatearMoneda(productoSeleccionado.total_2026) }}</small>
                            </div>
                            <div class="progress mt-1" style="height: 4px;">
                                <div class="progress-bar bg-warning" [style.width.%]="(productoSeleccionado.total_2026 / productoSeleccionado.total_cuatrienio) * 100"></div>
                            </div>
                        </div>
                        <div class="budget-summary-item">
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">2027</small>
                                <small>{{ formatearMoneda(productoSeleccionado.total_2027) }}</small>
                            </div>
                            <div class="progress mt-1" style="height: 4px;">
                                <div class="progress-bar bg-success" [style.width.%]="(productoSeleccionado.total_2027 / productoSeleccionado.total_cuatrienio) * 100"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Comparativa Presupuestal PDM vs Ejecuci√≥n -->
                <div class="card mb-3" *ngIf="ejecucionPresupuestal">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-balance-scale me-2"></i> Comparativa Presupuestal</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th class="text-muted small">A√±o</th>
                                        <th class="text-muted small text-end">Presupuesto PDM</th>
                                        <th class="text-muted small text-end">Pto. Definitivo</th>
                                        <th class="text-muted small text-end">Pagos Reales</th>
                                        <th class="text-muted small text-end">% Ejecutado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr *ngFor="let comp of comparativaPresupuestalCache">
                                        <td class="small"><strong>{{ comp.anio }}</strong></td>
                                        <td class="text-end small">{{ formatearMoneda(comp.pdm) }}</td>
                                        <td class="text-end small text-muted">{{ formatearMoneda(comp.ptoDefinitivo) }}</td>
                                        <td class="text-end small"><strong class="text-primary">{{ formatearMoneda(comp.pagos) }}</strong></td>
                                        <td class="text-end small">
                                            <span [class.text-success]="comp.porcentaje >= 95" 
                                                  [class.text-warning]="comp.porcentaje >= 70 && comp.porcentaje < 95"
                                                  [class.text-danger]="comp.porcentaje < 70">
                                                {{ comp.porcentaje | number:'1.0-0' }}%
                                            </span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="alert alert-info small mt-3 mb-0" role="alert">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Nota:</strong> El <strong>Pto. Definitivo</strong> es el presupuesto real asignado al producto (despu√©s de adiciones y reducciones). Los <strong class="text-primary">Pagos Reales</strong> son lo efectivamente ejecutado. El <strong>% Ejecutado</strong> se calcula: <code>Pagos / Pto. Definitivo</code>.
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i> Informaci√≥n Adicional</h6>
                    </div>
                    <div class="card-body">
                        <!-- Loading state -->
                        <div *ngIf="cargandoEjecucion" class="text-center py-3">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="text-muted small mt-2">Cargando ejecuci√≥n presupuestal...</p>
                        </div>

                        <!-- Si hay datos de ejecuci√≥n -->
                        <div *ngIf="!cargandoEjecucion && ejecucionPresupuestal">
                            <!-- Fuentes presupuestales -->
                            <div class="mb-3">
                                <label class="text-muted small"><strong>Fuentes Presupuestales</strong></label>
                                <ul class="list-unstyled small mb-0">
                                    <li *ngFor="let fuente of ejecucionPresupuestal.fuentes" class="mb-1">
                                        <i class="fas fa-circle text-primary me-2" style="font-size: 6px;"></i>
                                        {{ fuente }}
                                    </li>
                                </ul>
                            </div>

                            <hr>

                            <!-- Totales presupuestales -->
                            <div class="mb-2">
                                <label class="text-muted small"><strong>Ejecuci√≥n Presupuestal</strong></label>
                                <div class="table-responsive">
                                    <table class="table table-sm table-borderless mb-0">
                                        <tbody>
                                            <tr>
                                                <td class="text-muted small">Pto. Inicial:</td>
                                                <td class="text-end small">{{ formatearMoneda(ejecucionPresupuestal.totales.pto_inicial) }}</td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted small">Adici√≥n:</td>
                                                <td class="text-end small text-success">+{{ formatearMoneda(ejecucionPresupuestal.totales.adicion) }}</td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted small">Reducci√≥n:</td>
                                                <td class="text-end small text-danger">-{{ formatearMoneda(ejecucionPresupuestal.totales.reduccion) }}</td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted small">Cr√©dito:</td>
                                                <td class="text-end small">{{ formatearMoneda(ejecucionPresupuestal.totales.credito) }}</td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted small">Contracr√©dito:</td>
                                                <td class="text-end small">{{ formatearMoneda(ejecucionPresupuestal.totales.contracredito) }}</td>
                                            </tr>
                                            <tr class="border-top">
                                                <td class="text-muted small"><strong>Pto. Definitivo:</strong></td>
                                                <td class="text-end small"><strong>{{ formatearMoneda(ejecucionPresupuestal.totales.pto_definitivo) }}</strong></td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted small"><strong>Pagos:</strong></td>
                                                <td class="text-end small"><strong class="text-primary">{{ formatearMoneda(ejecucionPresupuestal.totales.pagos) }}</strong></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Si NO hay datos de ejecuci√≥n, mostrar campos originales -->
                        <div *ngIf="!cargandoEjecucion && !ejecucionPresupuestal">
                            <div class="mb-3">
                                <label class="text-muted small">Programa MGA</label>
                                <p class="small">{{ productoSeleccionado.detalle_completo.programa_mga }}</p>
                            </div>
                            <div class="mb-3">
                                <label class="text-muted small">ODS</label>
                                <p class="small">{{ productoSeleccionado.detalle_completo.ods }}</p>
                            </div>
                            <div class="mb-3">
                                <label class="text-muted small">Tipo de Acumulaci√≥n</label>
                                <p class="small">{{ productoSeleccionado.detalle_completo.tipo_acumulacion }}</p>
                            </div>
                            <div *ngIf="productoSeleccionado.detalle_completo.bpin">
                                <label class="text-muted small">BPIN</label>
                                <p class="small">{{ productoSeleccionado.detalle_completo.bpin }}</p>
                            </div>
                            <div class="alert alert-info small mt-3 mb-0" role="alert">
                                <i class="fas fa-info-circle me-2"></i>
                                No hay datos de ejecuci√≥n presupuestal disponibles para este producto.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- VISTA: AN√ÅLISIS DETALLADO DEL PRODUCTO -->
    <div *ngIf="archivoExcelCargado && vistaActual === 'analisis-producto' && productoSeleccionado" class="vista-analisis-producto">
        <div class="container-fluid">
            <!-- Encabezado del Producto -->
            <div class="card mb-4">
                <div class="card-body">
                    <h4 class="mb-2">{{ productoSeleccionado.codigo }}</h4>
                    <p class="text-muted mb-0">{{ productoSeleccionado.producto }}</p>
                </div>
            </div>

            <!-- Estad√≠sticas Generales -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-bullseye fa-2x text-primary mb-2"></i>
                            <h6 class="text-muted small mb-1">Meta Cuatrienio</h6>
                            <h4 class="mb-0">{{ formatearNumero(productoSeleccionado.meta_cuatrienio || 0) }}</h4>
                            <small class="text-muted">{{ productoSeleccionado.unidad_medida }}</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-chart-line fa-2x text-info mb-2"></i>
                            <h6 class="text-muted small mb-1">Meta Programada</h6>
                            <h4 class="mb-0">{{ formatearNumero((productoSeleccionado.programacion_2024 || 0) + (productoSeleccionado.programacion_2025 || 0) + (productoSeleccionado.programacion_2026 || 0) + (productoSeleccionado.programacion_2027 || 0)) }}</h4>
                            <small class="text-muted">{{ productoSeleccionado.unidad_medida }}</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                            <h6 class="text-muted small mb-1">Meta Ejecutada</h6>
                            <h4 class="mb-0">{{ formatearNumero(metaEjecutadaTotalCache) }}</h4>
                            <small class="text-muted">{{ productoSeleccionado.unidad_medida }}</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-percentage fa-2x text-warning mb-2"></i>
                            <h6 class="text-muted small mb-1">% Avance</h6>
                            <h4 class="mb-0">{{ productoSeleccionado.porcentaje_ejecucion.toFixed(1) }}%</h4>
                            <small class="text-muted">del cuatrienio</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gr√°ficos -->
            <div class="row">
                <!-- Gr√°fico de Progreso por A√±o -->
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Progreso por A√±o</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="chartProgresoAnual"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Gr√°fico de Meta vs Ejecutado -->
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-chart-area me-2"></i>Meta vs Ejecutado por A√±o</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="chartMetaEjecutado"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Gr√°fico de Presupuesto Acumulado -->
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-dollar-sign me-2"></i>Presupuesto por A√±o</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="chartPresupuestoAnual"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Tabla de Resumen Anual -->
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-table me-2"></i>Resumen Anual</h6>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>A√±o</th>
                                        <th class="text-end">Programado</th>
                                        <th class="text-end">Ejecutado</th>
                                        <th class="text-end">%</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr *ngFor="let anio of [2024, 2025, 2026, 2027]">
                                        <td><strong>{{ anio }}</strong></td>
                                        <td class="text-end">{{ formatearNumero(obtenerMetaProgramada(anio)) }}</td>
                                        <td class="text-end">{{ formatearNumero(obtenerMetaEjecutada(anio)) }}</td>
                                        <td class="text-end">
                                            <span [class]="'badge ' + (obtenerPorcentajeAnio(anio) >= 75 ? 'bg-success' : obtenerPorcentajeAnio(anio) >= 50 ? 'bg-warning' : 'bg-danger')">
                                                {{ obtenerPorcentajeAnio(anio).toFixed(1) }}%
                                            </span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: CREAR/EDITAR ACTIVIDAD CON EVIDENCIA -->
    <div *ngIf="mostrarModalActividad" class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-clipboard-check me-2"></i>
                        {{ actividadEnEdicion ? 'Editar Evidencia de Ejecuci√≥n' : 'Nueva Evidencia de Ejecuci√≥n' }} - A√±o {{ anioSeleccionado }}
                    </h5>
                    <button type="button" class="btn-close" (click)="cerrarModalActividad()"></button>
                </div>
                <form [formGroup]="formularioActividad" (ngSubmit)="guardarActividad()">
                    <div class="modal-body">
                        <div class="alert alert-info mb-4">
                            <i class="fas fa-info-circle me-1"></i>
                            <strong>Meta Disponible:</strong> {{ formatearNumero(resumenAnioActual?.meta_disponible || 0) }} {{ productoSeleccionado?.unidad_medida }}
                        </div>

                        <!-- Secci√≥n 1: Informaci√≥n de la Actividad -->
                        <div class="card mb-4">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="fas fa-clipboard-list me-2"></i>Informaci√≥n de la Evidencia de Ejecuci√≥n</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        <label class="form-label fw-bold">Nombre de la Evidencia <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" formControlName="nombre" placeholder="Ej: Ejecuci√≥n de capacitaci√≥n en gesti√≥n de proyectos">
                                        <div *ngIf="formularioActividad.get('nombre')?.invalid && formularioActividad.get('nombre')?.touched" class="text-danger small">
                                            M√≠nimo 5 caracteres
                                        </div>
                                    </div>

                                    <div class="col-md-12 mb-3">
                                        <label class="form-label fw-bold">Descripci√≥n <span class="text-danger">*</span></label>
                                        <textarea class="form-control" formControlName="descripcion" rows="3" placeholder="Describa detalladamente la evidencia de ejecuci√≥n de la meta"></textarea>
                                        <div *ngIf="formularioActividad.get('descripcion')?.invalid && formularioActividad.get('descripcion')?.touched" class="text-danger small">
                                            M√≠nimo 10 caracteres
                                        </div>
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Secretar√≠a Responsable <span class="text-danger">*</span></label>
                                        <select 
                                            class="form-select" 
                                            [value]="formularioActividad.get('responsable_secretaria_id')?.value"
                                            (change)="formularioActividad.patchValue({responsable_secretaria_id: $any($event.target).value})"
                                            [disabled]="formularioActividad.get('responsable_secretaria_id')?.disabled">
                                            <option [value]="null">Seleccione una secretar√≠a...</option>
                                            <option *ngFor="let secretaria of secretariasAgrupadas" [value]="secretaria.id">
                                                üè¢ {{ secretaria.nombre }}
                                            </option>
                                        </select>
                                        <small class="text-muted d-block mt-1" *ngIf="!formularioActividad.get('responsable_secretaria_id')?.disabled">
                                            <i class="fas fa-info-circle"></i> Todos los usuarios de esta secretar√≠a podr√°n ver y registrar evidencia
                                        </small>
                                        <small class="text-success d-block mt-1" *ngIf="formularioActividad.get('responsable_secretaria_id')?.disabled">
                                            <i class="fas fa-lock"></i> Su secretar√≠a ha sido asignada autom√°ticamente
                                        </small>
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Estado <span class="text-danger">*</span></label>
                                        <select class="form-select" formControlName="estado">
                                            <option value="PENDIENTE">Pendiente</option>
                                            <option value="EN_PROGRESO">En Progreso</option>
                                            <option value="CANCELADA">Cancelada</option>
                                        </select>
                                    </div>

                                    <div class="col-md-4 mb-3">
                                        <label class="form-label fw-bold">Fecha Inicio <span class="text-danger">*</span></label>
                                        <input type="date" class="form-control" formControlName="fecha_inicio">
                                    </div>

                                    <div class="col-md-4 mb-3">
                                        <label class="form-label fw-bold">Fecha Fin <span class="text-danger">*</span></label>
                                        <input type="date" class="form-control" formControlName="fecha_fin">
                                    </div>

                                    <div class="col-md-4 mb-3">
                                        <label class="form-label fw-bold">Meta a Ejecutar <span class="text-danger">*</span></label>
                                        <input type="number" class="form-control" formControlName="meta_ejecutar" step="0.01" [placeholder]="'Max: ' + (resumenAnioActual?.meta_disponible || 0)">
                                        <small class="text-muted">{{ productoSeleccionado?.unidad_medida }}</small>
                                        <div *ngIf="formularioActividad.get('meta_ejecutar')?.invalid && formularioActividad.get('meta_ejecutar')?.touched" class="text-danger small">
                                            Valor inv√°lido o excede la meta disponible
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Secci√≥n 2: Evidencia de Cumplimiento (Obligatoria) -->
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="fas fa-camera me-2"></i>Evidencia de Cumplimiento <span class="text-danger">*</span></h6>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-success border">
                                    <i class="fas fa-check-circle me-2"></i>
                                    La evidencia es <strong>obligatoria</strong> para registrar la ejecuci√≥n de la meta. Debe proporcionar al menos una URL o im√°genes.
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold">URL de Evidencia Externa</label>
                                    <input type="url" class="form-control" formControlName="evidencia_url" placeholder="https://ejemplo.com/evidencia">
                                    <small class="text-muted">Enlace a documentos en la nube, videos, etc. (Obligatorio si no carga im√°genes)</small>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold">Im√°genes (M√°ximo 4, 2MB cada una)</label>
                                    <input type="file" class="form-control" accept="image/*" multiple (change)="onImagenesSeleccionadas($event)">
                                    <small class="text-muted">Puede cargar hasta 4 im√°genes de m√°ximo 2MB cada una (Obligatorio si no proporciona URL)</small>
                                </div>

                                <div *ngIf="formularioActividad.get('imagenes')?.value?.length > 0" class="mb-3">
                                    <label class="form-label fw-bold">Vista Previa de Im√°genes</label>
                                    <div class="row">
                                        <div *ngFor="let imagen of formularioActividad.get('imagenes')?.value; let i = index" class="col-md-3 mb-2 position-relative">
                                            <img [src]="imagen" class="img-thumbnail" style="max-height: 150px; width: 100%; object-fit: cover;">
                                            <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1" (click)="eliminarImagen(i)">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" (click)="cerrarModalActividad()" [disabled]="guardandoEvidencia">Cancelar</button>
                        <button type="submit" class="btn btn-success" [disabled]="!formularioActividad.valid || !tieneEvidenciaValida() || guardandoEvidencia">
                            <span *ngIf="guardandoEvidencia" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            <i *ngIf="!guardandoEvidencia" class="fas fa-check me-1"></i>
                            <span *ngIf="guardandoEvidencia">{{ actividadEnEdicion ? 'Actualizando' : 'Guardando' }}...</span>
                            <span *ngIf="!guardandoEvidencia">{{ actividadEnEdicion ? 'Actualizar' : 'Registrar' }} Evidencia de Ejecuci√≥n</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- VISTA: AN√ÅLISIS Y DASHBOARDS -->
    <div *ngIf="archivoExcelCargado && vistaActual === 'analytics' && dashboardAnalytics" class="vista-analytics">
        <!-- Resumen General -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted">Total Productos</h6>
                        <h2 class="text-primary">{{ dashboardAnalytics.resumen_general.total_productos }}</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted">Avance Global</h6>
                        <h2 class="text-success">{{ dashboardAnalytics.resumen_general.porcentaje_avance_global.toFixed(1) }}%</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted">Presupuesto Total</h6>
                        <h2 class="text-info">{{ formatearMoneda(dashboardAnalytics.resumen_general.presupuesto_total) }}</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted">Sin Actividades</h6>
                        <h2 class="text-warning">{{ dashboardAnalytics.resumen_general.productos_sin_actividades }}</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- GR√ÅFICOS ESTAD√çSTICOS -->
        <div class="row mb-4">
            <!-- Gr√°fico de Torta - Distribuci√≥n por Estado -->
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Distribuci√≥n por Estado</h5>
                    </div>
                    <div class="card-body">
                        <div style="position: relative; height: 350px;">
                            <canvas id="chartEstados"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gr√°fico de Barras - Top Sectores -->
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Top 10 Sectores</h5>
                    </div>
                    <div class="card-body">
                        <div style="position: relative; height: 350px;">
                            <canvas id="chartSectores"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <!-- Gr√°fico de Barras - Metas Totales vs Ejecutadas por A√±o -->
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Metas Totales vs Ejecutadas por A√±o</h5>
                    </div>
                    <div class="card-body">
                        <div style="position: relative; height: 400px;">
                            <canvas id="chartMetasEjecutadas"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gr√°fico de Barras - Presupuesto por A√±o -->
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Presupuesto por A√±o</h5>
                    </div>
                    <div class="card-body">
                        <div style="position: relative; height: 400px;">
                            <canvas id="chartPresupuestoPorAnio"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TABLAS DETALLADAS -->
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Informaci√≥n Detallada:</strong> A continuaci√≥n se presentan las tablas con informaci√≥n detallada por cada categor√≠a de an√°lisis.
        </div>

        <!-- An√°lisis por Estado -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-table me-2"></i>Detalle por Estado</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Estado</th>
                                        <th class="text-center">Cantidad</th>
                                        <th class="text-center">Porcentaje</th>
                                        <th>Visual</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr *ngFor="let item of dashboardAnalytics.por_estado">
                                        <td>
                                            <span class="badge" [style.background-color]="item.color">{{ item.estado }}</span>
                                        </td>
                                        <td class="text-center">{{ item.cantidad }}</td>
                                        <td class="text-center">{{ item.porcentaje.toFixed(1) }}%</td>
                                        <td>
                                            <div class="progress" style="height: 25px;">
                                                <div class="progress-bar" [style.width.%]="item.porcentaje" [style.background-color]="item.color">
                                                    {{ item.porcentaje.toFixed(0) }}%
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- An√°lisis por L√≠nea Estrat√©gica -->
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-table me-2"></i>Detalle por L√≠nea Estrat√©gica</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-sm table-hover">
                                <thead class="sticky-top bg-white">
                                    <tr>
                                        <th>L√≠nea</th>
                                        <th class="text-center">Productos</th>
                                        <th class="text-center">Cumplimiento</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr *ngFor="let item of dashboardAnalytics.por_linea_estrategica">
                                        <td><small>{{ item.linea }}</small></td>
                                        <td class="text-center">{{ item.total_productos }}</td>
                                        <td class="text-center">
                                            <span class="badge" [class.bg-success]="item.porcentaje_cumplimiento >= 75"
                                                  [class.bg-warning]="item.porcentaje_cumplimiento >= 50 && item.porcentaje_cumplimiento < 75"
                                                  [class.bg-danger]="item.porcentaje_cumplimiento < 50">
                                                {{ item.porcentaje_cumplimiento.toFixed(0) }}%
                                            </span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- An√°lisis por Sector -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-table me-2"></i>Detalle de An√°lisis por Sector MGA</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Sector</th>
                                        <th class="text-center">Total</th>
                                        <th class="text-center">Completados</th>
                                        <th class="text-center">En Progreso</th>
                                        <th class="text-center">Pendientes</th>
                                        <th class="text-center">% Avance</th>
                                        <th class="text-end">Presupuesto</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr *ngFor="let item of dashboardAnalytics.por_sector">
                                        <td><strong>{{ item.sector }}</strong></td>
                                        <td class="text-center">{{ item.total_productos }}</td>
                                        <td class="text-center"><span class="badge bg-success">{{ item.productos_completados }}</span></td>
                                        <td class="text-center"><span class="badge bg-info">{{ item.productos_en_progreso }}</span></td>
                                        <td class="text-center"><span class="badge bg-warning">{{ item.productos_pendientes }}</span></td>
                                        <td class="text-center">
                                            <div class="progress" style="height: 20px; min-width: 80px;">
                                                <div class="progress-bar" [class]="'bg-' + (item.porcentaje_avance >= 75 ? 'success' : item.porcentaje_avance >= 50 ? 'warning' : 'danger')"
                                                     [style.width.%]="item.porcentaje_avance">
                                                    {{ item.porcentaje_avance.toFixed(0) }}%
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-end">{{ formatearMoneda(item.presupuesto_total) }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- GR√ÅFICOS ODS Y SECTORES -->
        <div class="row mb-4">
            <!-- Gr√°fico de Dona - ODS -->
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Top 10 ODS</h5>
                    </div>
                    <div class="card-body">
                        <div style="position: relative; height: 400px;">
                            <canvas id="chartODS"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gr√°fico de Barras Horizontales - Sectores Avance -->
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Top 8 Sectores - Avance</h5>
                    </div>
                    <div class="card-body">
                        <div style="position: relative; height: 400px;">
                            <canvas id="chartSectoresDetalle"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- An√°lisis por ODS (Tabla Detallada) -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="fas fa-table me-2"></i>Detalle por ODS</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-sm table-hover">
                                <thead class="sticky-top bg-white">
                                    <tr>
                                        <th>ODS</th>
                                        <th class="text-center">Productos</th>
                                        <th class="text-center">Avance %</th>
                                        <th class="text-end">Presupuesto</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr *ngFor="let item of dashboardAnalytics.por_ods">
                                        <td><small>{{ item.ods }}</small></td>
                                        <td class="text-center">{{ item.total_productos }}</td>
                                        <td class="text-center">{{ item.porcentaje_avance_promedio.toFixed(1) }}%</td>
                                        <td class="text-end"><small>{{ formatearMoneda(item.presupuesto_asignado) }}</small></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- An√°lisis Presupuestal por A√±o -->
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0"><i class="fas fa-dollar-sign me-2"></i>An√°lisis Presupuestal por A√±o</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th class="text-white bg-secondary">A√±o</th>
                                        <th class="text-end text-white bg-secondary">Programado</th>
                                        <th class="text-end text-white bg-secondary">Con Actividades</th>
                                        <th class="text-center text-white bg-secondary">% Asignaci√≥n</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr *ngFor="let item of dashboardAnalytics.analisis_presupuestal">
                                        <td><strong>{{ item.anio }}</strong></td>
                                        <td class="text-end">{{ formatearMoneda(item.presupuesto_programado) }}</td>
                                        <td class="text-end">{{ formatearMoneda(item.presupuesto_asignado_actividades) }}</td>
                                        <td class="text-center">
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar bg-primary" [style.width.%]="item.porcentaje_asignacion">
                                                    {{ item.porcentaje_asignacion.toFixed(0) }}%
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ‚úÖ NUEVO: An√°lisis por Secretar√≠a (Tabla Detallada) -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-building me-2"></i>An√°lisis por Secretar√≠a</h5>
            </div>
            <div class="card-body">
                <!-- Gr√°fico de desempe√±o por secretar√≠a -->
                <div class="mb-4" style="position: relative; height: 500px; overflow: hidden;">
                    <canvas id="chartSecretarias"></canvas>
                </div>

                <!-- Tabla detallada -->
                <div class="table-responsive" style="margin-top: 1.5rem;">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Secretar√≠a</th>
                                <th class="text-center">Productos</th>
                                <th class="text-center">Completados</th>
                                <th class="text-center">En Progreso</th>
                                <th class="text-center">Pendientes</th>
                                <th class="text-center">Por Ejecutar</th>
                                <th class="text-center">Avance %</th>
                                <th class="text-center">Actividades</th>
                                <th class="text-end">Presupuesto</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let item of analisisPorSecretaria" [class.table-success]="item.porcentaje_avance_promedio >= 80" [class.table-warning]="item.porcentaje_avance_promedio < 50">
                                <td><strong>{{ item.nombre_secretaria }}</strong></td>
                                <td class="text-center"><span class="badge bg-primary">{{ item.total_productos }}</span></td>
                                <td class="text-center"><span class="badge bg-success">{{ item.productos_completados }}</span></td>
                                <td class="text-center"><span class="badge bg-info">{{ item.productos_en_progreso }}</span></td>
                                <td class="text-center"><span class="badge bg-warning text-dark">{{ item.productos_pendientes }}</span></td>
                                <td class="text-center"><span class="badge bg-secondary">{{ item.productos_por_ejecutar }}</span></td>
                                <td class="text-center">
                                    <div class="progress" style="height: 25px;">
                                        <div class="progress-bar"
                                             [style.width.%]="item.porcentaje_avance_promedio"
                                             [ngClass]="{
                                                 'bg-success': item.porcentaje_avance_promedio >= 80,
                                                 'bg-info': item.porcentaje_avance_promedio >= 50 && item.porcentaje_avance_promedio < 80,
                                                 'bg-warning': item.porcentaje_avance_promedio < 50
                                             }">
                                            {{ item.porcentaje_avance_promedio.toFixed(1) }}%
                                        </div>
                                    </div>
                                </td>
                                <td class="text-center">
                                    <small>{{ item.actividades_completadas }}/{{ item.total_actividades }}</small>
                                </td>
                                <td class="text-end"><strong>{{ formatearMoneda(item.presupuesto_total) }}</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <p *ngIf="analisisPorSecretaria.length === 0" class="text-muted text-center mt-3">
                    No hay datos de secretar√≠as disponibles
                </p>
            </div>
        </div>
    </div>

    <!-- MODAL: INFORMACI√ìN BPIN -->
    <div *ngIf="mostrarModalBPIN" class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-project-diagram me-2"></i>
                        Informaci√≥n del Proyecto BPIN
                    </h5>
                    <button type="button" class="btn-close btn-close-white" (click)="cerrarModalBPIN()"></button>
                </div>
                <div class="modal-body">
                    <!-- Loading -->
                    <div *ngIf="cargandoBPIN" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-3 text-muted">Consultando datos del proyecto...</p>
                    </div>

                    <!-- No encontrado -->
                    <div *ngIf="!cargandoBPIN && !proyectoBPIN" class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        No se encontr√≥ informaci√≥n para este c√≥digo BPIN en la base de datos de datos.gov.co
                    </div>

                    <!-- Informaci√≥n del proyecto -->
                    <div *ngIf="!cargandoBPIN && proyectoBPIN">
                        <div class="mb-3">
                            <label class="text-muted small">C√≥digo BPIN</label>
                            <h5 class="text-primary">{{ proyectoBPIN.bpin }}</h5>
                        </div>

                        <div class="mb-3">
                            <label class="text-muted small">Nombre del Proyecto</label>
                            <p class="fw-bold">{{ proyectoBPIN.nombreproyecto }}</p>
                        </div>

                        <div class="mb-3">
                            <label class="text-muted small">Objetivo General</label>
                            <p>{{ proyectoBPIN.objetivogeneral }}</p>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="text-muted small">Estado del Proyecto</label>
                                <p>
                                    <span class="badge text-dark" [class.bg-success]="proyectoBPIN.estadoproyecto === 'VIABLE'" 
                                          [class.bg-warning]="proyectoBPIN.estadoproyecto === 'EN ESTUDIO'"
                                          [class.bg-info]="proyectoBPIN.estadoproyecto === 'ACTIVO'">
                                        {{ proyectoBPIN.estadoproyecto }}
                                    </span>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <label class="text-muted small">Horizonte</label>
                                <p>{{ proyectoBPIN.horizonte }}</p>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="text-muted small">Sector</label>
                                <p>{{ proyectoBPIN.sector }}</p>
                            </div>
                            <div class="col-md-6">
                                <label class="text-muted small">Entidad Responsable</label>
                                <p>{{ proyectoBPIN.entidadresponsable }}</p>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <label class="text-muted small">Valor Total del Proyecto</label>
                                <h5 class="text-success">{{ formatearMoneda(proyectoBPIN.valortotalproyecto) }}</h5>
                            </div>
                            <div class="col-md-6">
                                <label class="text-muted small">Valor Vigente</label>
                                <h5 class="text-info">{{ formatearMoneda(proyectoBPIN.valorvigenteproyecto) }}</h5>
                            </div>
                        </div>

                        <hr>

                        <div class="text-muted small">
                            <i class="fas fa-database me-1"></i>
                            Datos obtenidos de: <a href="https://www.datos.gov.co/Hacienda-y-Cr-dito-P-blico/BANCO-DE-PROGRAMAS-Y-PROYECTOS/cf9k-55fw" target="_blank">datos.gov.co</a>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" (click)="cerrarModalBPIN()">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Cargar Ejecuci√≥n Presupuestal -->
    <div *ngIf="mostrarModalEjecucion" class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-file-invoice-dollar me-2"></i>
                        Cargar Ejecuci√≥n Presupuestal
                    </h5>
                    <button type="button" class="btn-close btn-close-white" (click)="cerrarModalEjecucion()"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Importante:</strong> La carga reemplazar√° todos los datos de ejecuci√≥n existentes para el a√±o seleccionado.
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">A√±o de Ejecuci√≥n <span class="text-danger">*</span></label>
                        <select class="form-select" [(ngModel)]="anioEjecucionSeleccionado">
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                            <option value="2027">2027</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Archivo Excel/CSV</label>
                        <input type="file" class="form-control" accept=".xlsx,.xls,.csv" (change)="onEjecucionFileSelected($event)" #fileEjecucionInput>
                        <small class="text-muted">Formatos aceptados: .xlsx, .xls, .csv</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" (click)="cerrarModalEjecucion()">Cancelar</button>
                    <button type="button" class="btn btn-success" (click)="confirmarCargaEjecucion()" [disabled]="!archivoEjecucionTemporal">
                        <i class="fas fa-upload me-1"></i> Cargar Ejecuci√≥n
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: An√°lisis Detallado del Producto -->
</div>
