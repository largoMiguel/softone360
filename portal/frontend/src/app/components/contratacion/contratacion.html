<div class="contratacion-container">
    <!-- HEADER con navegación de vistas -->
    <div class="page-header">
        <div class="header-content">
            <div class="header-info">
                <h2 class="page-title">
                    <i class="fas fa-handshake"></i>
                    <span *ngIf="vistaActual === 'dashboard'">Análisis de Contratación</span>
                    <span *ngIf="vistaActual === 'lista'">Listado de Contratos</span>
                    <span *ngIf="vistaActual === 'detalle'">Detalle del Contrato</span>
                    <span class="badge ms-2" [class.bg-primary]="tipoSecop === 'secop2'" [class.bg-success]="tipoSecop === 'secop1'">
                        {{ tipoSecop === 'secop1' ? 'SECOP I' : 'SECOP II' }}
                    </span>
                </h2>
            </div>
            <div class="header-actions">
                <button *ngIf="vistaActual === 'dashboard'" class="btn btn-success me-2" (click)="navegarA('lista')">
                    <i class="fas fa-list"></i> Ver Contratos
                </button>
                <button *ngIf="vistaActual !== 'dashboard'" class="btn btn-outline-secondary me-2" (click)="volver()">
                    <i class="fas fa-arrow-left"></i> Volver
                </button>
                <button *ngIf="vistaActual === 'lista'" class="btn btn-outline-primary me-2" (click)="exportCSV()" title="Exportar CSV (respeta orden)">
                    <i class="fas fa-file-csv"></i> CSV
                </button>
            </div>
        </div>
        <p class="page-subtitle" *ngIf="vistaActual === 'dashboard'">
            KPIs, alertas y análisis de los procesos de contratación {{ tipoSecop === 'secop1' ? 'SECOP I' : 'SECOP II' }}
        </p>
    </div>

    <!-- LOADING -->
    <div *ngIf="loading" class="loading-overlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-3 text-muted">Cargando datos de contratación...</p>
    </div>

    <!-- VISTA: DASHBOARD -->
    <div *ngIf="vistaActual === 'dashboard' && !loading" class="vista-dashboard">
        <!-- Filtro global por rango de fechas -->
        <div class="global-filters mb-3 p-3 border rounded bg-light">
            <div class="row g-2 align-items-end">
                <div class="col-6 col-md-auto">
                    <label class="form-label mb-1">Desde</label>
                    <input type="date" class="form-control form-control-sm" [(ngModel)]="filtro.fechaDesde">
                </div>
                <div class="col-6 col-md-auto">
                    <label class="form-label mb-1">Hasta</label>
                    <input type="date" class="form-control form-control-sm" [(ngModel)]="filtro.fechaHasta">
                </div>
                <div class="col-6 col-md-auto">
                    <button class="btn btn-sm btn-primary mt-3" (click)="buscar()" title="Aplicar rango">
                        <i class="fas fa-search me-1"></i>Buscar
                    </button>
                </div>
                <div class="col-6 col-md-auto">
                    <button class="btn btn-sm btn-outline-secondary mt-3" (click)="limpiar()" title="Restablecer rango">
                        <i class="fas fa-broom me-1"></i>Limpiar
                    </button>
                </div>
            </div>
            <small class="text-muted">Filtra por fecha de firma del contrato (SECOP {{ tipoSecop === 'secop1' ? 'I' : 'II' }}). Si el rango es inválido se auto-ajusta.</small>
        </div>
        <!-- Alertas -->
        <div class="row g-3 mb-4">
            <!-- Alerta Contratos Vencidos -->
            <div class="col-12" *ngIf="contratosVencidos.length > 0">
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-exclamation-circle me-3" style="font-size: 1.5rem;"></i>
                        <div>
                            <h5 class="alert-heading mb-1">⚠️ Contratos Vencidos</h5>
                            <p class="mb-0 small">Tienes {{ contratosVencidos.length }} contrato(s) vencido(s)</p>
                        </div>
                        <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
                    </div>
                    <button class="btn btn-sm btn-outline-danger mt-2" (click)="mostrarContratosVencidos = !mostrarContratosVencidos">
                        <i class="fas fa-chevron-down me-1"></i> {{ mostrarContratosVencidos ? 'Ocultar' : 'Ver Detalles' }}
                    </button>
                    <div class="row g-2 mt-3" *ngIf="mostrarContratosVencidos">
                        <div class="col-md-6 mb-2" *ngFor="let c of contratosVencidos">
                            <div class="card p-3 border-danger">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">{{ c.referencia_del_contrato || c.referencia_del_proceso }}</h6>
                                        <p class="mb-1 small"><strong>Objeto:</strong> {{ (c.objeto_del_contrato || c.descripcion_del_proceso || 'N/D') | slice:0:80 }}{{ (c.objeto_del_contrato || c.descripcion_del_proceso || '').length > 80 ? '...' : '' }}</p>
                                        <small class="text-muted">Proveedor: {{ c.proveedor_adjudicado }}</small>
                                        <div class="mt-2">
                                            <span class="badge" [ngClass]="'bg-' + getEstadoBadgeClass(c.estado_contrato)">{{ c.estado_contrato }}</span>
                                        </div>
                                    </div>
                                    <button class="btn btn-sm btn-outline-primary" (click)="navegarA('detalle', c)">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alerta Contratos Retrasados -->
            <div class="col-12" *ngIf="contratosRetrasados.length > 0">
                <div class="alert alert-warning alert-dismissible fade show" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-clock me-3" style="font-size: 1.5rem;"></i>
                        <div>
                            <h5 class="alert-heading mb-1">⏱️ Contratos en Riesgo</h5>
                            <p class="mb-0 small">Tienes {{ contratosRetrasados.length }} contrato(s) con ejecución retrasada (>75% ejecutado, <15 días para vencer)</p>
                        </div>
                        <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
                    </div>
                    <button class="btn btn-sm btn-outline-warning mt-2" (click)="mostrarContratosRetrasados = !mostrarContratosRetrasados">
                        <i class="fas fa-chevron-down me-1"></i> {{ mostrarContratosRetrasados ? 'Ocultar' : 'Ver Detalles' }}
                    </button>
                    <div class="row g-2 mt-3" *ngIf="mostrarContratosRetrasados">
                        <div class="col-md-6 mb-2" *ngFor="let c of contratosRetrasados">
                            <div class="card p-3 border-warning">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">{{ c.referencia_del_contrato || c.referencia_del_proceso }}</h6>
                                        <p class="mb-1 small"><strong>Objeto:</strong> {{ (c.objeto_del_contrato || c.descripcion_del_proceso || 'N/D') | slice:0:80 }}{{ (c.objeto_del_contrato || c.descripcion_del_proceso || '').length > 80 ? '...' : '' }}</p>
                                        <small class="text-muted">Proveedor: {{ c.proveedor_adjudicado }}</small>
                                        <div class="mt-2">
                                            <span class="badge bg-warning text-dark">Seguimiento Intensivo</span>
                                        </div>
                                    </div>
                                    <button class="btn btn-sm btn-outline-primary" (click)="navegarA('detalle', c)">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- KPIs -->
        <div class="row g-3 mb-4">
            <div class="col-md-3 mb-3">
                <div class="kpi-card kpi-primary clickeable" (click)="selectedKpi = 'totalProcesos'; kpiDetailVisible = !kpiDetailVisible" [class.active]="selectedKpi === 'totalProcesos'">
                    <div class="kpi-icon"><i class="fas fa-file-contract"></i></div>
                    <div class="kpi-info">
                        <div class="kpi-value">{{ kpis.totalProcesos }}</div>
                        <div class="kpi-label">Total Procesos</div>
                    </div>
                    <i class="fas fa-chevron-right kpi-arrow"></i>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="kpi-card kpi-success clickeable" (click)="selectedKpi = 'adjudicados'; kpiDetailVisible = !kpiDetailVisible" [class.active]="selectedKpi === 'adjudicados'">
                    <div class="kpi-icon"><i class="fas fa-check-circle"></i></div>
                    <div class="kpi-info">
                        <div class="kpi-value">{{ kpis.totalAdjudicados }}</div>
                        <div class="kpi-label">Adjudicados</div>
                    </div>
                    <i class="fas fa-chevron-right kpi-arrow"></i>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="kpi-card kpi-info clickeable" (click)="selectedKpi = 'tasa'; kpiDetailVisible = !kpiDetailVisible" [class.active]="selectedKpi === 'tasa'">
                    <div class="kpi-icon"><i class="fas fa-percentage"></i></div>
                    <div class="kpi-info">
                        <div class="kpi-value">{{ (kpis.tasaAdjudicacion | number:'1.1-1') }}%</div>
                        <div class="kpi-label">Tasa Adjudicación</div>
                    </div>
                    <i class="fas fa-chevron-right kpi-arrow"></i>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="kpi-card kpi-warning clickeable" (click)="selectedKpi = 'monto'; kpiDetailVisible = !kpiDetailVisible" [class.active]="selectedKpi === 'monto'">
                    <div class="kpi-icon"><i class="fas fa-money-bill-wave"></i></div>
                    <div class="kpi-info">
                        <div class="kpi-value">$ {{ (kpis.sumaAdjudicado | number:'1.0-0') }}</div>
                        <div class="kpi-label">Monto Adjudicado</div>
                    </div>
                    <i class="fas fa-chevron-right kpi-arrow"></i>
                </div>
            </div>
        </div>

        <!-- KPIs adicionales -->
        <div class="row g-3 mb-4">
            <div class="col-md-3 mb-3">
                <div class="kpi-card clickeable" (click)="selectedKpi = 'tiempoPromedio'; kpiDetailVisible = !kpiDetailVisible" [class.active]="selectedKpi === 'tiempoPromedio'">
                    <div class="kpi-icon" style="background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);"><i class="fas fa-hourglass-half"></i></div>
                    <div class="kpi-info">
                        <div class="kpi-value">{{ tiempoPromedioEjecucion }} días</div>
                        <div class="kpi-label">Tiempo Promedio Ejecución</div>
                    </div>
                    <i class="fas fa-chevron-right kpi-arrow"></i>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="kpi-card kpi-danger clickeable" (click)="selectedKpi = 'vencidos'; kpiDetailVisible = !kpiDetailVisible" [class.active]="selectedKpi === 'vencidos'">
                    <div class="kpi-icon" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);"><i class="fas fa-times-circle"></i></div>
                    <div class="kpi-info">
                        <div class="kpi-value">{{ contratosVencidosCount }}</div>
                        <div class="kpi-label">Contratos Vencidos</div>
                    </div>
                    <i class="fas fa-chevron-right kpi-arrow"></i>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="kpi-card clickeable" (click)="selectedKpi = 'proximos'; kpiDetailVisible = !kpiDetailVisible" [class.active]="selectedKpi === 'proximos'">
                    <div class="kpi-icon" style="background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); color: #212529;"><i class="fas fa-bell"></i></div>
                    <div class="kpi-info">
                        <div class="kpi-value">{{ contratosProximosAVencer }}</div>
                        <div class="kpi-label">Próximos a Vencer</div>
                    </div>
                    <i class="fas fa-chevron-right kpi-arrow"></i>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="kpi-card clickeable" (click)="selectedKpi = 'estados'; kpiDetailVisible = !kpiDetailVisible" [class.active]="selectedKpi === 'estados'">
                    <div class="kpi-icon" style="background: linear-gradient(135deg, #17a2b8 0%, #128293 100%);"><i class="fas fa-list"></i></div>
                    <div class="kpi-info">
                        <div class="kpi-value">{{ Object.keys(distribucionEstados).length }}</div>
                        <div class="kpi-label">Estados Únicos</div>
                    </div>
                    <i class="fas fa-chevron-right kpi-arrow"></i>
                </div>
            </div>
        </div>

        <!-- Panel de Detalle KPI -->
        <div *ngIf="kpiDetailVisible && selectedKpi" class="card mb-4 detail-kpi-panel">
            <div class="card-header">
                <h5 class="mb-0">Detalle: {{ selectedKpi | uppercase }}</h5>
            </div>
            <div class="card-body" [ngSwitch]="selectedKpi">
                <div *ngSwitchCase="'totalProcesos'">
                    <p>Total de procesos de contratación registrados en el período.</p>
                    <h3 class="text-primary">{{ kpis.totalProcesos }}</h3>
                </div>
                <div *ngSwitchCase="'adjudicados'">
                    <p>Procesos finalizados y adjudicados.</p>
                    <h3 class="text-success">{{ kpis.totalAdjudicados }}</h3>
                </div>
                <div *ngSwitchCase="'tasa'">
                    <p>Porcentaje de procesos que llegaron a adjudicación.</p>
                    <h3 class="text-info">{{ (kpis.tasaAdjudicacion | number:'1.1-1') }}%</h3>
                </div>
                <div *ngSwitchCase="'monto'">
                    <p>Valor total de los contratos adjudicados.</p>
                    <h3 class="text-warning">$ {{ (kpis.sumaAdjudicado | number:'1.0-0') }}</h3>
                </div>
                <div *ngSwitchCase="'tiempoPromedio'">
                    <p>Duración promedio de los contratos en ejecución.</p>
                    <h3 class="text-secondary">{{ tiempoPromedioEjecucion }} días</h3>
                </div>
                <div *ngSwitchCase="'vencidos'">
                    <p>Contratos que han superado su fecha de vencimiento.</p>
                    <h3 class="text-danger">{{ contratosVencidosCount }}</h3>
                </div>
                <div *ngSwitchCase="'proximos'">
                    <p>Contratos próximos a vencer en los próximos 15 días.</p>
                    <h3 class="text-warning">{{ contratosProximosAVencer }}</h3>
                </div>
                <div *ngSwitchCase="'estados'">
                    <p>Cantidad de estados diferentes en los contratos.</p>
                    <div class="mt-3">
                        <div *ngFor="let entry of Object.entries(distribucionEstados)" class="mb-2">
                            <span class="badge" [ngClass]="'bg-' + getEstadoBadgeClass(entry[0])">{{ entry[0] }}: {{ entry[1] }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráficas -->
        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <div class="card chart-card">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Por Estado</h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="chart-estados" baseChart [data]="estadosChartData" [type]="doughnutChartType"
                                [options]="chartOptions"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card chart-card">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Modalidades</h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="chart-modalidades" baseChart [data]="modalidadesChartData" [type]="barChartType"
                                [options]="chartOptions"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card chart-card">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>Timeline</h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="chart-timeline" baseChart [data]="timelineChartData" [type]="lineChartType"
                                [options]="chartOptions"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-md-6">
                <div class="card chart-card shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Tipos de Contrato</h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="chart-tipos" baseChart [data]="tiposContratoChartData" [type]="doughnutChartType"
                                [options]="chartOptions"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card chart-card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>Evolución del Valor Contratado</h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="chart-valor-timeline" baseChart [data]="valorTimelineChartData" [type]="lineChartType"
                                [options]="chartOptions"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-12">
                <div class="card chart-card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0"><i class="fas fa-handshake me-2"></i>Top Proveedores por Valor Contratado</h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="height: 320px;">
                            <canvas id="chart-proveedores" baseChart [data]="proveedoresChartData" [type]="barChartType"
                                [options]="proveedoresChartOptions"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- VISTA: LISTA DE CONTRATOS -->
    <div *ngIf="vistaActual === 'lista' && !loading" class="vista-lista">
        <div class="card">
            <div class="card-header bg-white">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <h6 class="mb-0 d-flex align-items-center gap-2"><i class="fas fa-table text-primary"></i> Contratos ({{ procesosFiltrados.length }})</h6>
                    <div class="list-actions d-flex align-items-center gap-2"><!-- Botones densidad y ayuda removidos; CSV movido al header --></div>
                </div>
            </div>
            <div class="card-body">
                <!-- Barra de filtros compacta -->
                <div class="filters-toolbar mb-3 enhanced-filters">
                    <div class="row g-2 align-items-end">
                        <div class="col-12 col-md-3">
                            <label class="form-label mb-1">Referencia</label>
                            <input type="text" class="form-control form-control-sm" placeholder="Buscar..."
                                [ngModel]="columnFilters.referencia" (ngModelChange)="onFilterInput('referencia', $event)">
                        </div>
                        <div class="col-6 col-md-2">
                            <label class="form-label mb-1">Estado</label>
                            <select class="form-select form-select-sm" [(ngModel)]="columnFilters.estado"
                                (change)="applyLocalFilters()">
                                <option value="">Todos</option>
                                <option *ngFor="let e of estadosResumen" [value]="e">{{ e }}</option>
                            </select>
                        </div>
                        <div class="col-6 col-md-2">
                            <label class="form-label mb-1">Modalidad</label>
                            <select class="form-select form-select-sm" [(ngModel)]="columnFilters.modalidad"
                                (change)="applyLocalFilters()">
                                <option value="">Todas</option>
                                <option *ngFor="let m of modalidades" [value]="m">{{ m }}</option>
                            </select>
                        </div>
                        <div class="col-6 col-md-2">
                            <label class="form-label mb-1">Tipo</label>
                            <select class="form-select form-select-sm" [(ngModel)]="columnFilters.tipo"
                                (change)="applyLocalFilters()">
                                <option value="">Todos</option>
                                <option *ngFor="let t of tiposContrato" [value]="t">{{ t }}</option>
                            </select>
                        </div>
                        <div class="col-6 col-md-3">
                            <label class="form-label mb-1">Proveedor</label>
                            <input type="text" class="form-control form-control-sm" placeholder="Nombre o NIT"
                                [ngModel]="columnFilters.proveedor" (ngModelChange)="onFilterInput('proveedor', $event)">
                        </div>
                        <div class="col-6 col-md-3">
                            <label class="form-label mb-1">Valor min</label>
                            <input type="number" min="0" class="form-control form-control-sm" placeholder="0"
                                [(ngModel)]="columnFilters.precioMin" (ngModelChange)="applyLocalFilters()">
                        </div>
                        <div class="col-6 col-md-3">
                            <label class="form-label mb-1">Valor max</label>
                            <input type="number" min="0" class="form-control form-control-sm" placeholder="∞"
                                [(ngModel)]="columnFilters.precioMax" (ngModelChange)="applyLocalFilters()">
                        </div>
                        <div class="col-6 col-md-3">
                            <label class="form-label mb-1">Firma desde</label>
                            <input type="date" class="form-control form-control-sm"
                                [(ngModel)]="columnFilters.publicacionDesde" (change)="applyLocalFilters()">
                        </div>
                        <div class="col-6 col-md-3">
                            <label class="form-label mb-1">Firma hasta</label>
                            <input type="date" class="form-control form-control-sm"
                                [(ngModel)]="columnFilters.publicacionHasta" (change)="applyLocalFilters()">
                        </div>
                        <div class="col-12 col-md-2 text-md-end">
                            <button class="btn btn-sm btn-outline-secondary mt-3 mt-md-0" (click)="clearColumnFilters()"
                                    title="Limpiar filtros">
                                <i class="fas fa-broom me-1"></i>Limpiar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Controles de paginación superiores -->
                <div class="pagination-bar d-flex align-items-center justify-content-between flex-wrap mb-3">
                    <div class="text-muted small mb-2 mb-md-0">
                        Mostrando
                        <strong>{{ (pageIndex - 1) * pageSize + (paginatedProcesos.length ? 1 : 0) }}</strong>
                        –
                        <strong>{{ (pageIndex - 1) * pageSize + paginatedProcesos.length }}</strong>
                        de
                        <strong>{{ procesosFiltrados.length }}</strong>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <label class="form-label mb-0 me-2 small text-muted">Por página</label>
                        <select class="form-select form-select-sm" [(ngModel)]="pageSize"
                            (ngModelChange)="onPageSizeChange($event)">
                            <option *ngFor="let s of pageSizes" [ngValue]="s">{{ s }}</option>
                        </select>
                        <div class="btn-group btn-group-sm" role="group" aria-label="Paginación">
                            <button class="btn btn-outline-secondary" (click)="prevPage()"
                                [disabled]="pageIndex === 1">«</button>
                            <button *ngFor="let p of getPageNumbers()" class="btn" [class.btn-primary]="p === pageIndex"
                                [class.btn-outline-secondary]="p !== pageIndex" (click)="goToPage(p)">{{ p }}</button>
                            <button class="btn btn-outline-secondary" (click)="nextPage()"
                                [disabled]="pageIndex === totalPages">»</button>
                        </div>
                    </div>
                </div>

                <!-- Vista Tabla Única -->
                <div class="contracts-table-wrapper">
                    <table class="table contracts-table align-middle mb-0" [class.compact]="layoutDensity==='compact'">
                        <thead>
                            <tr>
                                <th (click)="onHeaderClick($event,'referencia')" class="sortable" [class.sorted]="getSortDir('referencia')" [class.sort-asc]="getSortDir('referencia')==='asc'" [class.sort-desc]="getSortDir('referencia')==='desc'" title="Referencia (Shift+click para multi-orden)">
                                    Referencia
                                    <span class="sort-indicator" *ngIf="getSortDir('referencia') as dir">
                                        <i class="fa" [ngClass]="{'fa-arrow-up': dir==='asc', 'fa-arrow-down': dir==='desc'}"></i>
                                        <span class="sort-index" *ngIf="getSortIndex('referencia') as idx">{{ idx }}</span>
                                    </span>
                                </th>
                                <th class="text-center sortable" (click)="onHeaderClick($event,'estado')" [class.sorted]="getSortDir('estado')" [class.sort-asc]="getSortDir('estado')==='asc'" [class.sort-desc]="getSortDir('estado')==='desc'" title="Estado (Shift+click para multi-orden)">
                                    Estado
                                    <span class="sort-indicator" *ngIf="getSortDir('estado') as dir">
                                        <i class="fa" [ngClass]="{'fa-arrow-up': dir==='asc', 'fa-arrow-down': dir==='desc'}"></i>
                                        <span class="sort-index" *ngIf="getSortIndex('estado') as idx">{{ idx }}</span>
                                    </span>
                                </th>
                                <th class="sortable" (click)="onHeaderClick($event,'modalidad')" [class.sorted]="getSortDir('modalidad')" [class.sort-asc]="getSortDir('modalidad')==='asc'" [class.sort-desc]="getSortDir('modalidad')==='desc'" title="Modalidad (Shift+click para multi-orden)">
                                    Modalidad
                                    <span class="sort-indicator" *ngIf="getSortDir('modalidad') as dir">
                                        <i class="fa" [ngClass]="{'fa-arrow-up': dir==='asc', 'fa-arrow-down': dir==='desc'}"></i>
                                        <span class="sort-index" *ngIf="getSortIndex('modalidad') as idx">{{ idx }}</span>
                                    </span>
                                </th>
                                <th class="sortable" (click)="onHeaderClick($event,'tipo')" [class.sorted]="getSortDir('tipo')" [class.sort-asc]="getSortDir('tipo')==='asc'" [class.sort-desc]="getSortDir('tipo')==='desc'" title="Tipo (Shift+click para multi-orden)">
                                    Tipo
                                    <span class="sort-indicator" *ngIf="getSortDir('tipo') as dir">
                                        <i class="fa" [ngClass]="{'fa-arrow-up': dir==='asc', 'fa-arrow-down': dir==='desc'}"></i>
                                        <span class="sort-index" *ngIf="getSortIndex('tipo') as idx">{{ idx }}</span>
                                    </span>
                                </th>
                                <th class="text-end sortable" (click)="onHeaderClick($event,'valor')" [class.sorted]="getSortDir('valor')" [class.sort-asc]="getSortDir('valor')==='asc'" [class.sort-desc]="getSortDir('valor')==='desc'" title="Valor (Shift+click para multi-orden)">
                                    Valor
                                    <span class="sort-indicator" *ngIf="getSortDir('valor') as dir">
                                        <i class="fa" [ngClass]="{'fa-arrow-up': dir==='asc', 'fa-arrow-down': dir==='desc'}"></i>
                                        <span class="sort-index" *ngIf="getSortIndex('valor') as idx">{{ idx }}</span>
                                    </span>
                                </th>
                                <th class="text-end sortable" (click)="onHeaderClick($event,'pagado')" [class.sorted]="getSortDir('pagado')" [class.sort-asc]="getSortDir('pagado')==='asc'" [class.sort-desc]="getSortDir('pagado')==='desc'" title="Pagado (Shift+click para multi-orden)">
                                    Pagado
                                    <span class="sort-indicator" *ngIf="getSortDir('pagado') as dir">
                                        <i class="fa" [ngClass]="{'fa-arrow-up': dir==='asc', 'fa-arrow-down': dir==='desc'}"></i>
                                        <span class="sort-index" *ngIf="getSortIndex('pagado') as idx">{{ idx }}</span>
                                    </span>
                                </th>
                                <th class="text-center">Avance</th>
                                <th class="sortable" (click)="onHeaderClick($event,'proveedor')" [class.sorted]="getSortDir('proveedor')" [class.sort-asc]="getSortDir('proveedor')==='asc'" [class.sort-desc]="getSortDir('proveedor')==='desc'" title="Proveedor (Shift+click para multi-orden)">
                                    Proveedor
                                    <span class="sort-indicator" *ngIf="getSortDir('proveedor') as dir">
                                        <i class="fa" [ngClass]="{'fa-arrow-up': dir==='asc', 'fa-arrow-down': dir==='desc'}"></i>
                                        <span class="sort-index" *ngIf="getSortIndex('proveedor') as idx">{{ idx }}</span>
                                    </span>
                                </th>
                                <th class="sortable" (click)="onHeaderClick($event,'inicio')" [class.sorted]="getSortDir('inicio')" [class.sort-asc]="getSortDir('inicio')==='asc'" [class.sort-desc]="getSortDir('inicio')==='desc'" title="Inicio (Shift+click para multi-orden)">
                                    Inicio
                                    <span class="sort-indicator" *ngIf="getSortDir('inicio') as dir">
                                        <i class="fa" [ngClass]="{'fa-arrow-up': dir==='asc', 'fa-arrow-down': dir==='desc'}"></i>
                                        <span class="sort-index" *ngIf="getSortIndex('inicio') as idx">{{ idx }}</span>
                                    </span>
                                </th>
                                <th class="sortable" (click)="onHeaderClick($event,'fin')" [class.sorted]="getSortDir('fin')" [class.sort-asc]="getSortDir('fin')==='asc'" [class.sort-desc]="getSortDir('fin')==='desc'" title="Fin (Shift+click para multi-orden)">
                                    Fin
                                    <span class="sort-indicator" *ngIf="getSortDir('fin') as dir">
                                        <i class="fa" [ngClass]="{'fa-arrow-up': dir==='asc', 'fa-arrow-down': dir==='desc'}"></i>
                                        <span class="sort-index" *ngIf="getSortIndex('fin') as idx">{{ idx }}</span>
                                    </span>
                                </th>
                                <!-- Acciones eliminadas: fila completa clickeable -->
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let p of paginatedProcesos; trackBy: trackByContrato" (click)="navegarA('detalle', p)" role="button" tabindex="0" (keydown.enter)="navegarA('detalle', p)">
                                <td class="ref-col">
                                    <div class="d-flex flex-column">
                                        <span class="fw-semibold ref-text">{{ (p.referencia_del_contrato || p.referencia_del_proceso) || 'N/D' }}</span>
                                        <small class="text-muted" *ngIf="isSinContrato(p)">Sin contrato</small>
                                    </div>
                                </td>
                                <td class="text-center">
                                    <span class="badge px-2 py-1" [ngClass]="getEstadoBadgeClass(p)">{{ getEstadoDisplay(p) }}</span>
                                    <span *ngIf="isSinContrato(p)" class="badge badge-sin-contrato ms-1" title="Proceso sin contrato adjudicado">Sin contrato</span>
                                </td>
                                <td><span class="text-truncate d-inline-block modal-label" title="{{ p.modalidad_de_contratacion }}">{{ p.modalidad_de_contratacion || 'N/D' }}</span></td>
                                <td><span class="text-truncate d-inline-block modal-label" title="{{ p.tipo_de_contrato }}">{{ p.tipo_de_contrato || 'N/D' }}</span></td>
                                <td class="text-end">$ {{ toNumber(p.valor_del_contrato) | number:'1.0-0' }}</td>
                                <td class="text-end">
                                    <ng-container *ngIf="!isSinContrato(p); else dashPagado">$ {{ toNumber(p.valor_pagado) | number:'1.0-0' }}</ng-container>
                                    <ng-template #dashPagado>—</ng-template>
                                </td>
                                <td class="text-center">
                                    <div class="progress progress-thin" *ngIf="!isSinContrato(p) && toNumber(p.valor_del_contrato)>0">
                                        <div class="progress-bar" role="progressbar" [style.width.%]="(toNumber(p.valor_pagado)/toNumber(p.valor_del_contrato))*100"></div>
                                    </div>
                                    <small *ngIf="!isSinContrato(p)">{{ ((toNumber(p.valor_pagado)/toNumber(p.valor_del_contrato))*100) | number:'1.0-1' }}%</small>
                                    <small *ngIf="isSinContrato(p)" class="text-muted">—</small>
                                </td>
                                <td>
                                    <span class="d-inline-block provider-cell" title="{{ p.proveedor_adjudicado || 'Sin proveedor' }}">{{ p.proveedor_adjudicado || 'Sin proveedor' }}</span>
                                </td>
                                <td>{{ p.fecha_de_inicio_del_contrato | date:'dd/MM/yyyy':'America/Bogota':'es-CO' }}</td>
                                <td>{{ p.fecha_de_fin_del_contrato | date:'dd/MM/yyyy':'America/Bogota':'es-CO' }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <!-- Paginación flotante -->
                <div class="floating-pagination">
                    <div class="d-flex align-items-center justify-content-between w-100">
                        <div class="small text-muted">Página {{ pageIndex }} de {{ totalPages }}</div>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary" (click)="prevPage()" [disabled]="pageIndex===1">«</button>
                            <button *ngFor="let p of getPageNumbers()" class="btn" [class.btn-primary]="p===pageIndex" [class.btn-outline-secondary]="p!==pageIndex" (click)="goToPage(p)">{{ p }}</button>
                            <button class="btn btn-outline-secondary" (click)="nextPage()" [disabled]="pageIndex===totalPages">»</button>
                        </div>
                    </div>
                </div>

                <!-- Controles de paginación inferiores -->
                <div class="pagination-bar d-flex align-items-center justify-content-between flex-wrap mt-3">
                    <div class="btn-group btn-group-sm" role="group" aria-label="Paginación">
                        <button class="btn btn-outline-secondary" (click)="prevPage()"
                            [disabled]="pageIndex === 1">«</button>
                        <button *ngFor="let p of getPageNumbers()" class="btn" [class.btn-primary]="p === pageIndex"
                            [class.btn-outline-secondary]="p !== pageIndex" (click)="goToPage(p)">{{ p }}</button>
                        <button class="btn btn-outline-secondary" (click)="nextPage()"
                            [disabled]="pageIndex === totalPages">»</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- VISTA: DETALLE DEL CONTRATO -->
    <div *ngIf="vistaActual === 'detalle' && selectedProceso && !loading" class="vista-detalle">
        <!-- Modal overlay de fondo -->
    </div>

    <!-- Modal de Detalle Minimalista -->
    <div class="modal-overlay" *ngIf="showModal && selectedProceso" (click)="closeModal()">
        <div class="modal-wrapper" (click)="$event.stopPropagation()">
            <div class="modal-content-custom">
                <!-- Header -->
                <div class="modal-header-custom" [attr.aria-label]="'Detalle contrato ' + (selectedProceso.referencia_del_contrato || selectedProceso.referencia_del_proceso)">
                    <div class="modal-title-section">
                        <i class="fas fa-file-contract"></i>
                        <div class="title-block">
                            <div class="ref-line">
                                <span class="modal-title">{{ (selectedProceso.referencia_del_contrato || selectedProceso.referencia_del_proceso) || 'N/D' }}</span>
                                <span *ngIf="selectedProceso.sin_contrato" class="badge badge-sin-contrato ms-1" title="Proceso sin contrato adjudicado">Sin contrato</span>
                                <span class="badge status-badge" [ngClass]="getEstadoBadgeClass(selectedProceso!)">{{ getEstadoDisplay(selectedProceso!) }}</span>
                                <button type="button" class="btn btn-sm btn-outline-secondary btn-copy-ref" (click)="copySelectedReferencia()" aria-label="Copiar referencia" title="Copiar referencia"><i class="fas fa-copy"></i></button>
                                <span class="copy-feedback" *ngIf="copyFeedback">{{ copyFeedback }}</span>
                            </div>
                            <div class="meta-line">
                                <span class="meta-item"><i class="far fa-calendar"></i> Inicio: {{ selectedProceso.fecha_de_inicio_del_contrato | date:'dd/MM/yyyy':'America/Bogota':'es-CO' }}</span>
                                <span class="meta-sep">→</span>
                                <span class="meta-item"><i class="far fa-calendar-check"></i> Fin: {{ selectedProceso.fecha_de_fin_del_contrato | date:'dd/MM/yyyy':'America/Bogota':'es-CO' }}</span>
                                <span class="meta-item" *ngIf="formatearDuracion(selectedProceso!) !== 'N/D'"><i class="fas fa-clock"></i> Duración: {{ formatearDuracion(selectedProceso!) }}</span>
                            </div>
                        </div>
                    </div>
                    <button class="close-btn" (click)="closeModal()" aria-label="Cerrar"><i class="fas fa-times"></i></button>
                </div>

                <!-- Body -->
                <div class="modal-body">
                    <!-- Bloques principales -->
                    <div class="summary-grid">
                        <div class="summary-card" aria-label="Resumen valores contrato">
                            <div class="sc-label">Valor Contrato</div>
                            <div class="sc-value">$ {{ toNumber(selectedProceso.valor_del_contrato) | number:'1.0-0' }}</div>
                            <div class="sc-sub" *ngIf="!selectedProceso.sin_contrato">Pagado: $ {{ toNumber(selectedProceso.valor_pagado) | number:'1.0-0' }}</div>
                            <div class="sc-progress" *ngIf="!selectedProceso.sin_contrato && toNumber(selectedProceso.valor_del_contrato)>0">
                                <div class="bar">
                                    <div class="fill" [style.width.%]="(toNumber(selectedProceso.valor_pagado)/toNumber(selectedProceso.valor_del_contrato))*100"></div>
                                </div>
                                <span class="pct">{{ ((toNumber(selectedProceso.valor_pagado)/toNumber(selectedProceso.valor_del_contrato))*100) | number:'1.0-1' }}%</span>
                                <span class="pct-badge">{{ ((toNumber(selectedProceso.valor_pagado)/toNumber(selectedProceso.valor_del_contrato))*100) | number:'1.0-1' }} ejecutado</span>
                            </div>
                        </div>
                        <div class="summary-card" aria-label="Resumen proveedor">
                            <div class="sc-label">Proveedor</div>
                            <div class="sc-value provider">{{ selectedProceso.proveedor_adjudicado || 'Sin proveedor' }}</div>
                            <div class="sc-sub">{{ selectedProceso.tipodocproveedor }} {{ selectedProceso.documento_proveedor || '' }}</div>
                            <div *ngIf="selectedProceso.es_pyme==='Si'" class="sc-tag pyme" aria-label="Proveedor es PYME">PYME</div>
                        </div>
                        <div class="summary-card">
                            <div class="sc-label">Tipo / Modalidad</div>
                            <div class="sc-value small">{{ selectedProceso.tipo_de_contrato || 'N/D' }}</div>
                            <div class="sc-sub">{{ selectedProceso.modalidad_de_contratacion || 'N/D' }}</div>
                        </div>
                        <div class="summary-card" *ngIf="selectedProceso.ultima_actualizacion">
                            <div class="sc-label">Actualización</div>
                            <div class="sc-value small">{{ selectedProceso.ultima_actualizacion | date:'dd/MM/yyyy':'America/Bogota':'es-CO' }}</div>
                            <div class="sc-sub">Supervisor: {{ selectedProceso.nombre_supervisor || 'N/D' }}</div>
                        </div>
                    </div>

                    <!-- Objeto -->
                    <div class="description-block">
                        <div class="desc-label">Objeto del contrato</div>
                        <p class="desc-text">{{ selectedProceso.objeto_del_contrato || 'Sin descripción' }}</p>
                    </div>

                    <!-- Toggle avanzado -->
                    <button class="btn btn-sm btn-outline-secondary advanced-toggle" (click)="toggleAdvanced()" [attr.aria-expanded]="showAdvanced">
                        <i class="fas" [ngClass]="showAdvanced ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                        {{ showAdvanced ? 'Ocultar detalles avanzados' : 'Ver detalles avanzados' }}
                    </button>

                    <!-- Detalles avanzados -->
                    <div class="advanced-section" *ngIf="showAdvanced">
                        <div class="advanced-grid">
                            <div class="adv-item" aria-label="Liquidación">
                                <span class="adv-label">Liquidación</span>
                                <span class="adv-value">{{ selectedProceso.liquidaci_n || 'Pendiente' }}</span>
                            </div>
                            <div class="adv-item">
                                <span class="adv-label">Pago adelantado</span>
                                <span class="adv-value">$ {{ toNumber(selectedProceso.valor_de_pago_adelantado) | number:'1.0-0' }}</span>
                            </div>
                            <div class="adv-item">
                                <span class="adv-label">Facturado</span>
                                <span class="adv-value">$ {{ toNumber(selectedProceso.valor_facturado) | number:'1.0-0' }}</span>
                            </div>
                            <div class="adv-item">
                                <span class="adv-label">Pendiente de pago</span>
                                <span class="adv-value">$ {{ toNumber(selectedProceso.valor_pendiente_de_pago) | number:'1.0-0' }}</span>
                            </div>
                            <div class="adv-item">
                                <span class="adv-label">Amortizado</span>
                                <span class="adv-value">$ {{ toNumber(selectedProceso.valor_amortizado) | number:'1.0-0' }}</span>
                            </div>
                            <div class="adv-item">
                                <span class="adv-label">Pendiente ejecución</span>
                                <span class="adv-value">$ {{ toNumber(selectedProceso.valor_pendiente_de_ejecucion) | number:'1.0-0' }}</span>
                            </div>
                            <div class="adv-item" *ngIf="selectedProceso.fecha_inicio_liquidacion">
                                <span class="adv-label">Inicio liquidación</span>
                                <span class="adv-value">{{ selectedProceso.fecha_inicio_liquidacion | date:'dd/MM/yyyy':'America/Bogota':'es-CO' }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Acciones -->
                <div class="modal-actions">
                    <button class="btn btn-outline-secondary" (click)="closeModal()"><i class="fas fa-times"></i><span>Cerrar</span></button>
                    <a class="btn btn-primary" [href]="getProcesoUrl(selectedProceso!)" target="_blank" rel="noopener noreferrer"><i class="fas fa-external-link-alt"></i><span>Ver en SECOP</span></a>
                </div>
            </div>
        </div>
    </div>

    <!-- Error message -->
    <div *ngIf="errorMsg" class="alert alert-danger mt-4" role="alert">
        {{ errorMsg }}
    </div>
</div>
