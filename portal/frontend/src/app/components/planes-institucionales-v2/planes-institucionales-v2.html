<div class="planes-institucionales-container">
    <!-- HEADER -->
    <div class="page-header">
        <div class="header-content">
            <div class="header-info">
                <h2 class="page-title">
                    <i class="fas fa-project-diagram"></i>
                    <span *ngIf="vistaActual === 'resumen'">Planes Institucionales</span>
                    <span *ngIf="vistaActual === 'gestion'">Gestión de Planes</span>
                    <span *ngIf="vistaActual === 'analisis'">Análisis de Planes</span>
                    <span *ngIf="vistaActual === 'componentes'">{{ planSeleccionado?.nombre }}</span>
                    <span *ngIf="vistaActual === 'actividades'">{{ componenteSeleccionado?.nombre }}</span>
                    <span *ngIf="vistaActual === 'detalle-actividad'">{{ actividadSeleccionada?.objetivo_especifico ||
                        'Actividad' }}</span>
                    <span *ngIf="vistaActual === 'estadisticas'">Estadísticas - {{ planSeleccionado?.nombre }}</span>
                </h2>
                <p class="page-subtitle" *ngIf="vistaActual === 'resumen'">
                    Resumen de planificación estratégica institucional
                </p>
                <p class="page-subtitle" *ngIf="vistaActual === 'gestion'">
                    Gestión de planificación estratégica institucional
                </p>
            </div>

            <div class="header-actions">
                <!-- Botones según vista -->
                <button *ngIf="vistaActual === 'resumen'" class="btn btn-success me-2" (click)="navegarA('analisis')">
                    <i class="fas fa-chart-pie"></i> Ver Análisis
                </button>
                <button *ngIf="vistaActual === 'resumen' && !esSecretario()" class="btn btn-primary me-2" (click)="navegarA('gestion')">
                    <i class="fas fa-arrow-right"></i> Ingresar
                </button>
                <button *ngIf="vistaActual !== 'resumen' && vistaActual !== 'gestion'" class="btn btn-outline-secondary me-2" (click)="volver()">
                    <i class="fas fa-arrow-left"></i> Volver
                </button>
                <button *ngIf="vistaActual === 'gestion' && !esSecretario()" class="btn btn-success me-2" (click)="abrirModalPlan()">
                    <i class="fas fa-plus"></i> Nuevo Plan
                </button>
                <button *ngIf="vistaActual === 'gestion'" class="btn btn-outline-primary me-2" (click)="cargarPlanes()">
                    <i class="fas fa-sync"></i> Actualizar
                </button>
                <button *ngIf="vistaActual === 'gestion'" class="btn btn-outline-secondary" (click)="navegarA('resumen')">
                    <i class="fas fa-arrow-left"></i> Volver
                </button>
            </div>
        </div>
    </div>

    <!-- LOADING -->
    <div *ngIf="cargando" class="loading-overlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
    </div>

    <!-- VISTA RESUMEN -->
    <div *ngIf="vistaActual === 'resumen'" class="vista-resumen">
        <!-- Selector de Año como en PDM -->
        <div class="card mb-4 bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i> Año de Seguimiento</h5>
                    <div class="btn-group" role="group">
                        <button type="button" 
                                class="btn"
                                [class.btn-light]="filtroAnio === ''"
                                [class.btn-outline-light]="filtroAnio !== ''"
                                (click)="filtroAnio = ''; cargarPlanes()">
                            Todos
                        </button>
                        <button *ngFor="let ano of anosDisponibles" 
                                type="button" 
                                class="btn"
                                [class.btn-light]="filtroAnio === ano"
                                [class.btn-outline-light]="filtroAnio !== ano"
                                (click)="filtroAnio = ano; cargarPlanes()">
                            {{ ano }}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estadísticas Globales -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="stat-card card clickable" (click)="navegarA('gestion')" title="Ver todos los planes">
                    <div class="card-body">
                        <div class="stat-icon">
                            <i class="fas fa-clipboard-list fa-2x text-primary"></i>
                        </div>
                        <div class="stat-info">
                            <h3 class="stat-value">{{ totalPlanesResumen }}</h3>
                            <p class="stat-label">Total Planes</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card card">
                    <div class="card-body">
                        <div class="stat-icon">
                            <i class="fas fa-play-circle fa-2x text-info"></i>
                        </div>
                        <div class="stat-info">
                            <h3 class="stat-value">{{ planesActivosResumen }}</h3>
                            <p class="stat-label">Planes Activos</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card card">
                    <div class="card-body">
                        <div class="stat-icon">
                            <i class="fas fa-check-circle fa-2x text-success"></i>
                        </div>
                        <div class="stat-info">
                            <h3 class="stat-value">{{ planesFinalizadosResumen }}</h3>
                            <p class="stat-label">Finalizados</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card card">
                    <div class="card-body">
                        <div class="stat-icon">
                            <i class="fas fa-chart-line fa-2x text-warning"></i>
                        </div>
                        <div class="stat-info">
                            <h3 class="stat-value">{{ avancePromedioResumen }}%</h3>
                            <p class="stat-label">Avance Promedio</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Botón Ver Todos -->
        <div class="text-center mb-4">
            <button class="btn btn-lg btn-outline-primary" (click)="navegarA('gestion')">
                <i class="fas fa-list"></i> Ver Todos los Planes Institucionales
            </button>
        </div>
    </div>

    <!-- VISTA GESTIÓN -->
    <div *ngIf="vistaActual === 'gestion'" class="vista-planes">

        <!-- Mensaje informativo para Secretarios -->
        <div *ngIf="esSecretario()" class="alert alert-info mb-3">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Vista de Secretario:</strong> Puedes navegar por los planes y componentes para acceder a las
            actividades asignadas a tu secretaría <strong>"{{ currentUser?.secretaria }}"</strong>.
            Solo podrás registrar avances y evidencias en tus actividades asignadas.
        </div>

        <!-- Controles de filtro (solo admins pueden crear) -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label">
                            <i class="fas fa-calendar"></i> Filtrar por Año
                        </label>
                        <select class="form-select" [(ngModel)]="filtroAnio" (change)="cargarPlanes()">
                            <option value="">Todos los años</option>
                            <option *ngFor="let ano of anosDisponibles" [value]="ano">{{ ano }}</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">
                            <i class="fas fa-filter"></i> Filtrar por Estado
                        </label>
                        <select class="form-select" [(ngModel)]="filtroEstadoPlan" (change)="cargarPlanes()">
                            <option value="">Todos los estados</option>
                            <option [value]="EstadoPlan.FORMULACION">{{ LABELS_ESTADO_PLAN[EstadoPlan.FORMULACION]
                                }}
                            </option>
                            <option [value]="EstadoPlan.APROBADO">{{ LABELS_ESTADO_PLAN[EstadoPlan.APROBADO] }}
                            </option>
                            <option [value]="EstadoPlan.EN_EJECUCION">{{ LABELS_ESTADO_PLAN[EstadoPlan.EN_EJECUCION]
                                }}
                            </option>
                            <option [value]="EstadoPlan.SUSPENDIDO">{{ LABELS_ESTADO_PLAN[EstadoPlan.SUSPENDIDO] }}
                            </option>
                            <option [value]="EstadoPlan.FINALIZADO">{{ LABELS_ESTADO_PLAN[EstadoPlan.FINALIZADO] }}
                            </option>
                            <option [value]="EstadoPlan.CANCELADO">{{ LABELS_ESTADO_PLAN[EstadoPlan.CANCELADO] }}
                            </option>
                        </select>
                    </div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-primary" (click)="abrirModalPlan()" *ngIf="!esSecretario()">
                            <i class="fas fa-plus"></i> Nuevo Plan
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lista de Planes -->
        <div class="row">
            <div class="col-12" *ngIf="planes.length === 0 && !cargando">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    No hay planes institucionales registrados.
                </div>
            </div>

            <div class="col-md-6 col-lg-4" *ngFor="let plan of planes">
                <div class="card plan-card mb-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <span [class]="BADGE_CLASS_ESTADO_PLAN[plan.estado]">
                                    {{ LABELS_ESTADO_PLAN[plan.estado] }}
                                </span>
                            </div>
                            <div class="dropdown" *ngIf="!esSecretario()">
                                <button class="btn btn-sm btn-link" data-bs-toggle="dropdown">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" (click)="abrirModalPlan(plan)">
                                            <i class="fas fa-edit"></i> Editar
                                        </a></li>
                                    <li><a class="dropdown-item text-danger" (click)="eliminarPlan(plan)">
                                            <i class="fas fa-trash"></i> Eliminar
                                        </a></li>
                                </ul>
                            </div>
                        </div>

                        <h5 class="card-title">{{ plan.nombre }}</h5>
                        <h6 class="card-subtitle mb-2 text-muted">Año {{ plan.anio }}</h6>
                        <p class="card-text small">{{ plan.descripcion | slice:0:120 }}...</p>

                        <div class="plan-meta mb-3">
                            <div class="meta-item">
                                <i class="fas fa-calendar"></i>
                                <span>{{ formatearFecha(plan.fecha_inicio) }} - {{
                                    formatearFecha(plan.fecha_fin)
                                    }}</span>
                            </div>

                        </div>

                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <small class="text-muted">Avance Global</small>
                                <small class="fw-bold">{{ plan.porcentaje_avance }}%</small>
                            </div>
                            <div class="progress">
                                <div class="progress-bar" [style.width.%]="plan.porcentaje_avance" role="progressbar">
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button class="btn btn-sm btn-primary" (click)="navegarA('componentes', plan)">
                                <i class="fas fa-sitemap"></i> Ver Componentes
                            </button>
                            <button class="btn btn-sm btn-outline-info" (click)="navegarA('estadisticas', plan)"
                                *ngIf="!esSecretario()">
                                <i class="fas fa-chart-bar"></i> Estadísticas
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- VISTA COMPONENTES -->
    <div *ngIf="vistaActual === 'componentes'" class="vista-componentes">
        <!-- Mensaje informativo para secretarios -->
        <div class="alert alert-info mb-3" *ngIf="esSecretario()">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Vista de Secretario:</strong> Puedes navegar por los componentes para acceder a tus actividades
            asignadas en la secretaría <strong>"{{ currentUser?.secretaria }}"</strong>.
            Solo verás las actividades donde puedes registrar avances.
        </div>

        <!-- Información del plan (visible para todos) -->
        <div class="card mb-4 plan-info-card" *ngIf="planSeleccionado">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h5>{{ planSeleccionado.nombre }}</h5>
                        <p class="text-muted mb-2">{{ planSeleccionado.descripcion }}</p>
                        <div class="plan-details">
                            <span class="me-3">
                                <i class="fas fa-calendar"></i>
                                {{ formatearFecha(planSeleccionado.fecha_inicio) }} - {{
                                formatearFecha(planSeleccionado.fecha_fin) }}
                            </span>
                            <span [class]="BADGE_CLASS_ESTADO_PLAN[planSeleccionado.estado]">
                                {{ LABELS_ESTADO_PLAN[planSeleccionado.estado] }}
                            </span>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="stat-box">
                            <div class="stat-value">{{ planSeleccionado.porcentaje_avance }}%</div>
                            <div class="stat-label">Avance Global</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Botón crear componente (solo admins) -->
        <div class="mb-4" *ngIf="!esSecretario()">
            <button class="btn btn-primary" (click)="abrirModalComponente()">
                <i class="fas fa-plus"></i> Nuevo Componente
            </button>
        </div>

        <!-- Lista de componentes (visible para todos) -->
        <div class="row">
            <div class="col-12" *ngIf="componentes.length === 0 && !cargando">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    No hay componentes registrados en este plan.
                </div>
            </div>

            <div class="col-lg-6" *ngFor="let componente of componentes">
                <div class="card componente-card mb-4">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0">{{ componente.nombre }}</h6>
                            </div>
                            <div>
                                <span class="badge bg-secondary">{{ LABELS_ESTADO_COMPONENTE[componente.estado]
                                    }}</span>
                                <button class="btn btn-sm btn-link" (click)="abrirModalComponente(componente)"
                                    *ngIf="!esSecretario()" title="Editar componente">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-link text-danger"
                                    (click)="$event.stopPropagation(); eliminarComponente(componente)"
                                    *ngIf="!esSecretario()" title="Eliminar componente">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">


                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <small>Avance</small>
                                <small class="fw-bold">{{ componente.porcentaje_avance }}%</small>
                            </div>
                            <div class="progress">
                                <div class="progress-bar bg-info" [style.width.%]="componente.porcentaje_avance">
                                </div>
                            </div>
                        </div>



                        <button class="btn btn-sm btn-outline-primary w-100 mt-3"
                            (click)="navegarA('actividades', componente)">
                            <i class="fas fa-list"></i> Ver Actividades
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- VISTA ACTIVIDADES -->
    <div *ngIf="vistaActual === 'actividades'" class="vista-actividades">
        <div class="card mb-4" *ngIf="componenteSeleccionado">
            <div class="card-body">
                <h5>{{ componenteSeleccionado.nombre }}</h5>
                <div class="d-flex gap-3">
                    <span class="badge bg-secondary">{{ LABELS_ESTADO_COMPONENTE[componenteSeleccionado.estado]
                        }}</span>
                </div>
            </div>
        </div>

        <!-- Mensaje informativo para secretarios -->
        <div *ngIf="esSecretario()" class="alert alert-info mb-3">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Vista de Secretario:</strong> Solo puedes ver actividades asignadas a tu secretaría
            <strong>"{{ currentUser?.secretaria }}"</strong> y registrar avances en ellas.
            Los administradores gestionan la creación y edición de actividades.
        </div>

        <!-- Solo admins pueden crear actividades -->
        <div class="mb-4 text-end" *ngIf="puedeEditarActividad()">
            <button class="btn btn-primary" (click)="abrirModalActividad()">
                <i class="fas fa-plus"></i> Nueva Actividad
            </button>
        </div>

        <div class="card">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Objetivo Específico</th>
                            <th>Inicio Previsto</th>
                            <th>Fin Previsto</th>
                            <th>Responsable</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngIf="componenteSeleccionado && actividades.length === 0 && !cargando">
                            <td colspan="8" class="text-center py-4">
                                <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                                <p class="text-muted">No hay actividades registradas</p>
                            </td>
                        </tr>
                        <tr *ngFor="let actividad of actividades" class="cursor-pointer"
                            (click)="navegarA('detalle-actividad', actividad)">
                            <td>{{ actividad.objetivo_especifico || '-' }}</td>
                            <td>{{ formatearFecha(actividad.fecha_inicio_prevista) }}</td>
                            <td>{{ formatearFecha(actividad.fecha_fin_prevista) }}</td>
                            <td>
                                <small>{{ actividad.responsable_secretaria_nombre || 'Sin asignar' }}</small>
                                <!-- Indicador visual para secretarios -->
                                <span *ngIf="esSecretario() && puedeRegistrarEjecucion(actividad)"
                                    class="badge bg-success ms-2" title="Puedes registrar avances">
                                    <i class="fas fa-check-circle"></i> Tu secretaría
                                </span>
                            </td>
                            <td>
                                <!-- Solo admins ven botón editar -->
                                <div class="btn-group btn-group-sm" *ngIf="puedeEditarActividad()">
                                    <button class="btn btn-outline-secondary"
                                        (click)="$event.stopPropagation(); abrirModalActividad(actividad)"
                                        title="Editar actividad">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-danger"
                                        (click)="$event.stopPropagation(); eliminarActividad(actividad)"
                                        title="Eliminar actividad">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                                <!-- Secretarios ven indicador si pueden registrar -->
                                <span *ngIf="esSecretario() && puedeRegistrarEjecucion(actividad)"
                                    class="text-success small">
                                    <i class="fas fa-plus-circle"></i> Puedes registrar
                                </span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- DETALLE ACTIVIDAD -->
    <div *ngIf="vistaActual === 'detalle-actividad'" class="vista-detalle-actividad">
        <div class="row" *ngIf="actividadSeleccionada">
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Actividad</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3" *ngIf="actividadSeleccionada.objetivo_especifico">
                            <h6>Objetivo Específico</h6>
                            <p>{{ actividadSeleccionada.objetivo_especifico }}</p>
                        </div>

                        <!-- Botón Registrar Ejecución con permisos -->
                        <button *ngIf="puedeRegistrarEjecucion(actividadSeleccionada)" class="btn btn-primary"
                            (click)="abrirModalEjecucion()">
                            <i class="fas fa-plus"></i> Registrar Ejecución
                        </button>

                        <!-- Mensaje informativo para secretarios sin permiso -->
                        <div *ngIf="esSecretario() && !puedeRegistrarEjecucion(actividadSeleccionada)"
                            class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            {{ mostrarMensajePermiso(actividadSeleccionada) }}
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-history"></i> Historial de Ejecuciones</h6>
                    </div>
                    <div class="card-body">
                        <div *ngIf="!actividadSeleccionada.actividades_ejecucion || actividadSeleccionada.actividades_ejecucion.length === 0"
                            class="text-center py-4">
                            <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                            <p class="text-muted">No hay ejecuciones registradas</p>
                        </div>

                        <div *ngFor="let ejecucion of actividadSeleccionada.actividades_ejecucion"
                            class="ejecucion-item mb-3 p-3 border rounded">
                            <div class="d-flex justify-content-between mb-2">
                                <small class="text-muted">{{ formatearFecha(ejecucion.fecha_registro) }}</small>
                            </div>
                            <p class="mb-2">{{ ejecucion.descripcion }}</p>

                            <!-- URL de evidencia -->
                            <div *ngIf="ejecucion.evidencia_url" class="mb-2">
                                <a [href]="ejecucion.evidencia_url" target="_blank"
                                    class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-external-link-alt me-1"></i> Ver documento externo
                                </a>
                            </div>

                            <!-- Galería de imágenes de evidencia -->
                            <div *ngIf="ejecucion.evidencias && ejecucion.evidencias.length > 0" class="mt-3">
                                <label class="small text-muted mb-2">
                                    <i class="fas fa-images me-1"></i> Evidencias fotográficas ({{
                                    ejecucion.evidencias.length }})
                                </label>
                                <div class="row g-2">
                                    <div *ngFor="let evidencia of ejecucion.evidencias" class="col-6 col-md-4 col-lg-3">
                                        <div class="evidencia-thumbnail" style="cursor: pointer;"
                                            (click)="verImagenCompleta(evidencia.contenido)">
                                            <img [src]="evidencia.contenido"
                                                [alt]="evidencia.nombre_archivo || 'Evidencia'"
                                                class="img-thumbnail w-100" style="height: 100px; object-fit: cover;">
                                            <small class="d-block text-truncate mt-1"
                                                [title]="evidencia.nombre_archivo">
                                                {{ evidencia.nombre_archivo || 'Imagen' }}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">Información</h6>
                    </div>
                    <div class="card-body">
                        <p class="small mb-2"><strong>Responsable (Secretaría):</strong><br>{{
                            actividadSeleccionada.responsable_secretaria_nombre || 'Sin asignar' }}</p>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">Fechas</h6>
                    </div>
                    <div class="card-body">
                        <p class="small mb-2"><strong>Inicio Previsto:</strong><br>{{
                            formatearFecha(actividadSeleccionada.fecha_inicio_prevista) }}</p>
                        <p class="small mb-2"><strong>Fin Previsto:</strong><br>{{
                            formatearFecha(actividadSeleccionada.fecha_fin_prevista) }}</p>

                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- ESTADÍSTICAS -->
    <div *ngIf="vistaActual === 'estadisticas'" class="vista-estadisticas">
        <div class="row" *ngIf="estadisticas">
            <div class="col-md-3 mb-4">
                <div class="stat-card card">
                    <div class="card-body text-center">
                        <i class="fas fa-sitemap fa-2x text-primary mb-2"></i>
                        <h3>{{ estadisticas.total_componentes }}</h3>
                        <p class="text-muted mb-0">Componentes</p>
                    </div>
                </div>
            </div>

            <div class="col-md-3 mb-4">
                <div class="stat-card card">
                    <div class="card-body text-center">
                        <i class="fas fa-tasks fa-2x text-info mb-2"></i>
                        <h3>{{ estadisticas.total_actividades }}</h3>
                        <p class="text-muted mb-0">Actividades</p>
                    </div>
                </div>
            </div>

            <div class="col-md-3 mb-4">
                <div class="stat-card card">
                    <div class="card-body text-center">
                        <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                        <h3>{{ estadisticas.componentes_con_avance }}</h3>
                        <p class="text-muted mb-0">Componentes con avance</p>
                    </div>
                </div>
            </div>

            <div class="col-md-3 mb-4">
                <div class="stat-card card">
                    <div class="card-body text-center">
                        <i class="fas fa-clipboard-check fa-2x text-success mb-2"></i>
                        <h3>{{ estadisticas.actividades_con_avance }}</h3>
                        <p class="text-muted mb-0">Actividades con avance</p>
                    </div>
                </div>
            </div>

            <div class="col-md-3 mb-4">
                <div class="stat-card card">
                    <div class="card-body text-center">
                        <i class="fas fa-chart-line fa-2x text-success mb-2"></i>
                        <h3>{{ estadisticas.porcentaje_avance_global }}%</h3>
                        <p class="text-muted mb-0">Avance Global</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- VISTA ANÁLISIS -->
        <!-- VISTA ANÁLISIS -->
    <div *ngIf="vistaActual === 'analisis'" class="vista-analisis">
        <!-- Selector de Año con Tabs -->
        <ul class="nav nav-tabs mb-4">
            <li class="nav-item">
                <a class="nav-link" [class.active]="filtroAnio === ''" (click)="filtroAnio = ''; cargarPlanes(); crearGraficoEstado(); crearGraficoAnios()" style="cursor: pointer;">
                    Todos
                </a>
            </li>
            <li class="nav-item" *ngFor="let ano of anosDisponibles">
                <a class="nav-link" [class.active]="filtroAnio === ano" (click)="filtroAnio = ano; cargarPlanes(); crearGraficoEstado(); crearGraficoAnios()" style="cursor: pointer;">
                    {{ ano }}
                </a>
            </li>
        </ul>

        <!-- Dashboard de Análisis -->
        <div class="row mb-4">
            <!-- Distribución por Estado -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-pie me-2 text-primary"></i>
                            Distribución por Estado
                        </h5>
                    </div>
                    <div class="card-body">
                        <div style="height: 300px; position: relative;">
                            <canvas #chartEstado></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Planes por Año -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar me-2 text-info"></i>
                            Planes por Año
                        </h5>
                    </div>
                    <div class="card-body">
                        <div style="height: 300px; position: relative;">
                            <canvas #chartAnios></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resumen de Estadísticas -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card border-primary">
                    <div class="card-body text-center">
                        <i class="fas fa-clipboard-list fa-3x text-primary mb-2"></i>
                        <h3 class="mb-0">{{ totalPlanesResumen }}</h3>
                        <p class="text-muted mb-0 small">Total de Planes</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card border-info">
                    <div class="card-body text-center">
                        <i class="fas fa-play-circle fa-3x text-info mb-2"></i>
                        <h3 class="mb-0">{{ planesEnEjecucionResumen }}</h3>
                        <p class="text-muted mb-0 small">En Ejecución</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card border-success">
                    <div class="card-body text-center">
                        <i class="fas fa-check-circle fa-3x text-success mb-2"></i>
                        <h3 class="mb-0">{{ planesFinalizadosAnalisisResumen }}</h3>
                        <p class="text-muted mb-0 small">Finalizados</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card border-warning">
                    <div class="card-body text-center">
                        <i class="fas fa-chart-line fa-3x text-warning mb-2"></i>
                        <h3 class="mb-0">{{ avancePromedioResumen }}%</h3>
                        <p class="text-muted mb-0 small">Avance Promedio</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tendencia de Avance -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line me-2 text-success"></i>
                            Tendencia de Avance - Top 10 Planes
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th width="35%">Plan</th>
                                        <th width="10%" class="text-center">Año</th>
                                        <th width="15%" class="text-center">Estado</th>
                                        <th width="40%">Avance</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr *ngFor="let plan of planes | slice:0:10">
                                        <td>
                                            <strong>{{ plan.nombre }}</strong>
                                            <br>
                                            <small class="text-muted">{{ plan.descripcion | slice:0:80 }}...</small>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-secondary">{{ plan.anio }}</span>
                                        </td>
                                        <td class="text-center">
                                            <span [class]="BADGE_CLASS_ESTADO_PLAN[plan.estado]">
                                                {{ LABELS_ESTADO_PLAN[plan.estado] }}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="progress flex-grow-1 me-2" style="height: 25px;">
                                                    <div class="progress-bar" 
                                                         [ngClass]="{
                                                            'bg-success': plan.porcentaje_avance >= 80,
                                                            'bg-info': plan.porcentaje_avance >= 50 && plan.porcentaje_avance < 80,
                                                            'bg-warning': plan.porcentaje_avance >= 25 && plan.porcentaje_avance < 50,
                                                            'bg-danger': plan.porcentaje_avance < 25
                                                         }"
                                                         [style.width.%]="plan.porcentaje_avance"
                                                         role="progressbar">
                                                        <span class="px-2">{{ plan.porcentaje_avance }}%</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr *ngIf="planes.length === 0">
                                        <td colspan="4" class="text-center text-muted">
                                            <i class="fas fa-info-circle me-2"></i>
                                            No hay planes registrados
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALES -->

    <!-- MODALES -->
    <!-- Plan -->
    <div class="modal fade show d-block" *ngIf="modalAbierto === 'plan'" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{ modoEdicion ? 'Editar Plan' : 'Nuevo Plan' }}</h5>
                    <button type="button" class="btn-close" (click)="cerrarModal()"></button>
                </div>
                <div class="modal-body">
                    <form #formPlan="ngForm">
                        <div class="mb-3">
                            <label class="form-label">Año *</label>
                            <input type="number" class="form-control" [(ngModel)]="planForm.anio" name="anio" min="2000"
                                max="2100" required #anioCtrl="ngModel"
                                [ngClass]="{'is-invalid': anioCtrl.invalid && anioCtrl.touched}">
                            <div class="invalid-feedback" *ngIf="anioCtrl.errors?.['required'] && anioCtrl.touched">
                                El
                                año es obligatorio</div>
                            <div class="invalid-feedback"
                                *ngIf="(anioCtrl.errors?.['min'] || anioCtrl.errors?.['max']) && anioCtrl.touched">
                                El
                                año debe estar entre 2000 y 2100</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nombre *</label>
                            <select class="form-select" [(ngModel)]="planForm.nombre" name="nombre" required
                                #nombreCtrl="ngModel"
                                [ngClass]="{'is-invalid': nombreCtrl.invalid && nombreCtrl.touched}">
                                <option value="" disabled selected>Seleccione un plan...</option>
                                <option *ngFor="let n of getNombresDisponibles()" [value]="n">{{ n }}</option>
                            </select>
                            <div class="invalid-feedback" *ngIf="nombreCtrl.invalid && nombreCtrl.touched">El nombre es obligatorio</div>
                            <div class="form-text text-muted" *ngIf="!modoEdicion && getNombresDisponibles().length === 0">
                                Ya se han creado todos los planes disponibles para el año {{ planForm.anio }}
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descripción *</label>
                            <textarea class="form-control" rows="3" [(ngModel)]="planForm.descripcion"
                                name="descripcion" required #descCtrl="ngModel"
                                [ngClass]="{'is-invalid': descCtrl.invalid && descCtrl.touched}"></textarea>
                            <div class="invalid-feedback" *ngIf="descCtrl.invalid && descCtrl.touched">La
                                descripción es
                                obligatoria</div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Fecha Inicio *</label>
                                <input type="date" class="form-control" [(ngModel)]="planForm.fecha_inicio"
                                    name="fecha_inicio" required #iniCtrl="ngModel"
                                    [ngClass]="{'is-invalid': iniCtrl.invalid && iniCtrl.touched}">
                                <div class="invalid-feedback" *ngIf="iniCtrl.invalid && iniCtrl.touched">La
                                    fecha de
                                    inicio es obligatoria</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Fecha Fin *</label>
                                <input type="date" class="form-control" [(ngModel)]="planForm.fecha_fin"
                                    name="fecha_fin" required #finCtrl="ngModel"
                                    [ngClass]="{'is-invalid': finCtrl.invalid && finCtrl.touched}">
                                <div class="invalid-feedback" *ngIf="finCtrl.invalid && finCtrl.touched">La
                                    fecha de
                                    fin
                                    es obligatoria</div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Estado *</label>
                                <select class="form-select" [(ngModel)]="planForm.estado" name="estado" required
                                    #estadoCtrl="ngModel"
                                    [ngClass]="{'is-invalid': estadoCtrl.invalid && estadoCtrl.touched}">
                                    <option [value]="EstadoPlan.FORMULACION">{{
                                        LABELS_ESTADO_PLAN[EstadoPlan.FORMULACION] }}</option>
                                    <option [value]="EstadoPlan.APROBADO">{{
                                        LABELS_ESTADO_PLAN[EstadoPlan.APROBADO]
                                        }}
                                    </option>
                                    <option [value]="EstadoPlan.EN_EJECUCION">{{
                                        LABELS_ESTADO_PLAN[EstadoPlan.EN_EJECUCION] }}</option>
                                    <option [value]="EstadoPlan.SUSPENDIDO">{{
                                        LABELS_ESTADO_PLAN[EstadoPlan.SUSPENDIDO]
                                        }}</option>
                                    <option [value]="EstadoPlan.FINALIZADO">{{
                                        LABELS_ESTADO_PLAN[EstadoPlan.FINALIZADO]
                                        }}</option>
                                </select>
                                <div class="invalid-feedback" *ngIf="estadoCtrl.invalid && estadoCtrl.touched">
                                    El
                                    estado
                                    es obligatorio</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Responsable de Elaboración *</label>
                                <input type="text" class="form-control" [(ngModel)]="planForm.responsable_elaboracion"
                                    name="responsable_elaboracion" required #respCtrl="ngModel"
                                    [ngClass]="{'is-invalid': respCtrl.invalid && respCtrl.touched}">
                                <div class="invalid-feedback" *ngIf="respCtrl.invalid && respCtrl.touched">El
                                    responsable de elaboración es obligatorio</div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" (click)="cerrarModal()">Cancelar</button>
                    <button type="button" class="btn btn-primary" [disabled]="formPlan.invalid"
                        (click)="guardarPlan()">{{
                        modoEdicion ? 'Actualizar' : 'Crear' }}</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Componente -->
    <div class="modal fade show d-block" *ngIf="modalAbierto === 'componente'"
        style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{ modoEdicion ? 'Editar Componente' : 'Nuevo Componente' }}</h5>
                    <button type="button" class="btn-close" (click)="cerrarModal()"></button>
                </div>
                <div class="modal-body">
                    <form #formComponente="ngForm">
                        <div class="mb-3">
                            <label class="form-label">Nombre *</label>
                            <input type="text" class="form-control" [(ngModel)]="componenteForm.nombre" name="nombre"
                                required #compNombre="ngModel"
                                [ngClass]="{'is-invalid': compNombre.invalid && compNombre.touched}">
                            <div class="invalid-feedback" *ngIf="compNombre.invalid && compNombre.touched">El
                                nombre
                                es
                                obligatorio</div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Estado *</label>
                                <select class="form-select" [(ngModel)]="componenteForm.estado" name="estado" required
                                    #compEstado="ngModel"
                                    [ngClass]="{'is-invalid': compEstado.invalid && compEstado.touched}">
                                    <option [value]="EstadoComponente.NO_INICIADO">{{
                                        LABELS_ESTADO_COMPONENTE[EstadoComponente.NO_INICIADO] }}</option>
                                    <option [value]="EstadoComponente.EN_PROGRESO">{{
                                        LABELS_ESTADO_COMPONENTE[EstadoComponente.EN_PROGRESO] }}</option>
                                    <option [value]="EstadoComponente.COMPLETADO">{{
                                        LABELS_ESTADO_COMPONENTE[EstadoComponente.COMPLETADO] }}</option>
                                    <option [value]="EstadoComponente.PAUSADO">{{
                                        LABELS_ESTADO_COMPONENTE[EstadoComponente.PAUSADO] }}</option>
                                </select>
                                <div class="invalid-feedback" *ngIf="compEstado.invalid && compEstado.touched">
                                    El
                                    estado
                                    es obligatorio</div>
                            </div>

                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" (click)="cerrarModal()">Cancelar</button>
                    <button type="button" class="btn btn-primary" [disabled]="formComponente.invalid"
                        (click)="guardarComponente()">{{ modoEdicion ?
                        'Actualizar' : 'Crear' }}</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Actividad -->
    <div class="modal fade show d-block" *ngIf="modalAbierto === 'actividad'"
        style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{ modoEdicion ? 'Editar Actividad' : 'Nueva Actividad' }}</h5>
                    <button type="button" class="btn-close" (click)="cerrarModal()"></button>
                </div>
                <div class="modal-body">
                    <form #formActividad="ngForm">
                        <div class="mb-3">
                            <label class="form-label">Objetivo Específico</label>
                            <textarea class="form-control" rows="2" [(ngModel)]="actividadForm.objetivo_especifico"
                                name="objetivo_especifico"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Fecha Inicio Prevista *</label>
                                <input type="date" class="form-control"
                                    [(ngModel)]="actividadForm.fecha_inicio_prevista" name="fecha_inicio_prevista"
                                    required #actIni="ngModel"
                                    [ngClass]="{'is-invalid': actIni.invalid && actIni.touched}">
                                <div class="invalid-feedback" *ngIf="actIni.invalid && actIni.touched">La fecha
                                    de
                                    inicio es obligatoria</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Fecha Fin Prevista *</label>
                                <input type="date" class="form-control" [(ngModel)]="actividadForm.fecha_fin_prevista"
                                    name="fecha_fin_prevista" required #actFin="ngModel"
                                    [ngClass]="{'is-invalid': actFin.invalid && actFin.touched}">
                                <div class="invalid-feedback" *ngIf="actFin.invalid && actFin.touched">La fecha
                                    de
                                    fin
                                    es obligatoria</div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Responsable (Secretaría) *</label>
                            <select class="form-select" [(ngModel)]="actividadForm.responsable_secretaria_id" name="responsable_secretaria_id"
                                required #actResp="ngModel"
                                [ngClass]="{'is-invalid': actResp.invalid && actResp.touched}">
                                <option [value]="null">Seleccione una secretaría...</option>
                                <option *ngFor="let s of secretarias" [value]="s.id">{{ s.nombre }}</option>
                            </select>
                            <div class="invalid-feedback" *ngIf="actResp.invalid && actResp.touched">El
                                responsable
                                es
                                obligatorio</div>
                            <small class="text-muted">Administra la lista en Usuarios → Secretarías.</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" (click)="cerrarModal()">Cancelar</button>
                    <button type="button" class="btn btn-primary" [disabled]="formActividad.invalid"
                        (click)="guardarActividad()">{{ modoEdicion ?
                        'Actualizar' : 'Crear' }}</button>
                </div>
            </div>
        </div>
    </div>



    <!-- Ejecución -->
    <div class="modal fade show d-block" *ngIf="modalAbierto === 'ejecucion'"
        style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Registrar Ejecución</h5>
                    <button type="button" class="btn-close" (click)="cerrarModal()"></button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="mb-3">
                            <label class="form-label">Descripción *</label>
                            <textarea class="form-control" rows="3" [(ngModel)]="ejecucionForm.descripcion"
                                name="descripcion" required></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">URL de Evidencia</label>
                            <input type="text" class="form-control" [(ngModel)]="ejecucionForm.evidencia_url"
                                name="evidencia_url" placeholder="https://ejemplo.com/documento.pdf">
                            <small class="text-muted">Enlace a documento externo (opcional)</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Imágenes de Evidencia (máximo 4)</label>
                            <input type="file" #fileInput class="form-control" accept="image/*" multiple
                                (change)="onFileSelected($event)" [disabled]="imagenesSeleccionadas.length >= 4">
                            <small class="text-muted">Tamaño máximo por imagen: 2MB. Formatos: JPG, PNG, GIF,
                                WEBP</small>
                        </div>

                        <!-- Vista previa de imágenes seleccionadas -->
                        <div *ngIf="imagenesSeleccionadas.length > 0" class="mb-3">
                            <label class="form-label">Imágenes seleccionadas
                                ({{imagenesSeleccionadas.length}}/4)</label>
                            <div class="row g-2">
                                <div *ngFor="let img of imagenesSeleccionadas; let i = index" class="col-6 col-md-3">
                                    <div class="position-relative">
                                        <img [src]="img.preview" class="img-thumbnail w-100"
                                            style="height: 120px; object-fit: cover;">
                                        <button type="button"
                                            class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1"
                                            (click)="eliminarImagenSeleccionada(i)"
                                            style="padding: 2px 6px; font-size: 0.75rem;">
                                            <i class="fas fa-times"></i>
                                        </button>
                                        <small class="d-block text-truncate mt-1">{{img.nombre}}</small>
                                        <small class="text-muted d-block">{{formatearTamano(img.tamano)}}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" (click)="cerrarModal()">Cancelar</button>
                    <button type="button" class="btn btn-primary" (click)="guardarEjecucion()"
                        [disabled]="!ejecucionForm.descripcion || guardandoEjecucion">
                        <span *ngIf="guardandoEjecucion" class="spinner-border spinner-border-sm me-2"></span>
                        {{ guardandoEjecucion ? 'Guardando...' : 'Registrar' }}
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>