<div class="modal-content">
    <div class="modal-header bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <h5 class="modal-title text-white fw-bold">
            <i class="fas fa-clipboard-check me-2"></i>
            Registrar Cumplimiento de Actividad
        </h5>
    </div>

    <div class="modal-body" style="max-height: 75vh; overflow-y: auto;">
        <!-- Header con código del producto -->
        <div class="card border-0 bg-light mb-4">
            <div class="card-body py-2">
                <div class="d-flex align-items-center">
                    <i class="fas fa-tag text-primary me-2"></i>
                    <small class="text-muted me-2">Producto:</small>
                    <strong class="text-primary">{{ data.codigo }}</strong>
                </div>
            </div>
        </div>

        <!-- Sección 1: Selección de Actividad -->
        <div class="mb-4">
            <h6 class="text-uppercase text-muted fw-bold mb-3" style="font-size: 0.85rem; letter-spacing: 0.5px;">
                <i class="fas fa-list-check me-2"></i>1. Seleccione la Actividad a Reportar
            </h6>

            <select class="form-select form-select-lg shadow-sm border-2" id="actividad" [(ngModel)]="actividadId"
                (change)="onActividadChange()" style="border-color: #667eea;">
                <option [ngValue]="null" disabled>-- Seleccione una actividad --</option>
                <option *ngFor="let act of actividades" [ngValue]="act.id">
                    {{ act.nombre }} (Año {{ act.anio }})
                </option>
            </select>
        </div>

        <!-- Info de la Actividad Seleccionada -->
        <div class="card border-0 shadow-sm mb-4" *ngIf="actividadSeleccionada"
            style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-12">
                        <div class="d-flex align-items-center mb-3">
                            <div class="rounded-circle bg-white p-2 me-3"
                                style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-bullseye text-primary"></i>
                            </div>
                            <div>
                                <small class="text-muted d-block" style="font-size: 0.75rem;">Actividad
                                    Seleccionada</small>
                                <strong class="text-dark">{{ actividadSeleccionada.nombre }}</strong>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="bg-white rounded p-3 text-center">
                            <i class="fas fa-calendar-alt text-primary mb-2"></i>
                            <div class="text-muted small">Año</div>
                            <div class="h5 mb-0 fw-bold text-primary">{{ actividadSeleccionada.anio }}</div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="bg-white rounded p-3 text-center">
                            <i class="fas fa-target text-success mb-2"></i>
                            <div class="text-muted small">Meta Asignada</div>
                            <div class="h5 mb-0 fw-bold text-success">{{ actividadSeleccionada.meta_ejecutar }}</div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="bg-white rounded p-3 text-center">
                            <i class="fas fa-check-circle text-info mb-2"></i>
                            <div class="text-muted small">Ejecutado</div>
                            <div class="h5 mb-0 fw-bold text-info">{{ totalEjecutado }}</div>
                        </div>
                    </div>

                    <div class="col-12">
                        <div class="alert alert-warning border-0 mb-0 d-flex align-items-center"
                            style="background-color: rgba(255, 193, 7, 0.1);">
                            <i class="fas fa-info-circle text-warning me-2"></i>
                            <div>
                                <strong>Importante:</strong> Al registrar este cumplimiento, se ejecutará la meta de
                                <strong>{{ actividadSeleccionada.meta_ejecutar }}</strong> unidades.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Historial de Ejecuciones (Colapsable) -->
        <div class="mb-4" *ngIf="actividadId && ejecuciones.length > 0">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="text-uppercase text-muted fw-bold mb-0" style="font-size: 0.85rem; letter-spacing: 0.5px;">
                    <i class="fas fa-history me-2"></i>Historial de Cumplimientos ({{ ejecuciones.length }})
                </h6>
                <button type="button" class="btn btn-sm btn-outline-secondary" (click)="toggleHistorial()">
                    <i class="fas" [ngClass]="mostrarHistorial ? 'fa-eye-slash' : 'fa-eye'"></i>
                    {{ mostrarHistorial ? 'Ocultar' : 'Ver Historial' }}
                </button>
            </div>

            <div *ngIf="mostrarHistorial" class="card border-0 shadow-sm">
                <div class="card-body p-0">
                    <div *ngIf="cargandoHistorial" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <div class="text-muted mt-2 small">Cargando historial...</div>
                    </div>

                    <div *ngIf="!cargandoHistorial && ejecuciones.length > 0" class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="border-0"><i class="fas fa-calendar me-1"></i>Fecha</th>
                                    <th class="border-0"><i class="fas fa-hashtag me-1"></i>Valor</th>
                                    <th class="border-0"><i class="fas fa-comment me-1"></i>Descripción</th>
                                    <th class="border-0"><i class="fas fa-paperclip me-1"></i>Evidencias</th>
                                    <th class="border-0"><i class="fas fa-user me-1"></i>Registrado por</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let ej of ejecuciones; let i = index" [class.table-light]="i % 2 === 0">
                                    <td class="text-nowrap">
                                        <small class="text-muted">{{ ej.created_at | date:'dd/MM/yy HH:mm' }}</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-success">{{ ej.valor_ejecutado_incremento }}</span>
                                    </td>
                                    <td>
                                        <small class="text-dark">{{ ej.descripcion || '—' }}</small>
                                    </td>
                                    <td>
                                        <div class="d-flex gap-1">
                                            <span *ngIf="ej.url_evidencia" class="badge bg-info" title="URL adjunta">
                                                <i class="fas fa-link"></i>
                                            </span>
                                            <span *ngIf="ej.imagenes && ej.imagenes.length > 0" class="badge bg-primary"
                                                title="{{ ej.imagenes.length }} imágenes">
                                                <i class="fas fa-images"></i> {{ ej.imagenes.length }}
                                            </span>
                                        </div>
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ ej.registrado_por }}</small>
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                        <div class="p-3 bg-light border-top">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-muted">Total Acumulado:</span>
                                <span class="h5 mb-0 text-success fw-bold">{{ totalEjecutado }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sección 2: Evidencias del Cumplimiento -->
        <div class="mb-4">
            <h6 class="text-uppercase text-muted fw-bold mb-3" style="font-size: 0.85rem; letter-spacing: 0.5px;">
                <i class="fas fa-file-alt me-2"></i>2. Registre las Evidencias del Cumplimiento
            </h6>

            <div class="alert alert-info border-0 d-flex align-items-start"
                style="background-color: rgba(102, 126, 234, 0.1);">
                <i class="fas fa-lightbulb text-primary me-2 mt-1"></i>
                <div>
                    <strong>Importante:</strong> Proporcione al menos una evidencia (descripción, URL o imágenes) que
                    respalde el cumplimiento de esta actividad.
                </div>
            </div>
        </div>

        <div class="row g-3">
            <!-- Descripción -->
            <div class="col-12">
                <label for="descripcion" class="form-label fw-semibold text-dark">
                    <i class="fas fa-align-left text-primary me-2"></i>Descripción del Cumplimiento
                </label>
                <textarea class="form-control form-control-lg shadow-sm border-2" id="descripcion" rows="4"
                    [(ngModel)]="descripcion"
                    placeholder="Describa brevemente cómo se cumplió con la actividad, resultados obtenidos, acciones realizadas..."
                    style="resize: none; border-color: #e0e0e0;"></textarea>
                <div class="form-text">
                    <i class="fas fa-info-circle me-1"></i>Proporcione detalles específicos del trabajo realizado
                </div>
            </div>

            <!-- URL -->
            <div class="col-12">
                <label for="url" class="form-label fw-semibold text-dark">
                    <i class="fas fa-link text-primary me-2"></i>Enlace a Documento o Evidencia Externa
                </label>
                <div class="input-group input-group-lg shadow-sm">
                    <span class="input-group-text bg-light border-2" style="border-color: #e0e0e0;">
                        <i class="fas fa-globe text-muted"></i>
                    </span>
                    <input type="url" class="form-control border-2" id="url" [(ngModel)]="url"
                        placeholder="https://ejemplo.com/documento.pdf" style="border-color: #e0e0e0;">
                </div>
                <div class="form-text">
                    <i class="fas fa-info-circle me-1"></i>Opcional: Link a Google Drive, OneDrive, sitio web, etc.
                </div>
            </div>

            <!-- Imágenes -->
            <div class="col-12">
                <label for="imagenes" class="form-label fw-semibold text-dark">
                    <i class="fas fa-camera text-primary me-2"></i>Fotografías o Capturas de Pantalla
                </label>
                <div class="border-2 border-dashed rounded p-4 text-center"
                    style="border-color: #e0e0e0; background-color: #fafafa;">
                    <input type="file" #fileInput class="d-none" id="imagenes" accept="image/*" multiple
                        (change)="onFileSelected($event)" [disabled]="imagenesSeleccionadas.length >= 4">

                    <button type="button" class="btn btn-outline-primary btn-lg mb-2" (click)="fileInput.click()"
                        [disabled]="imagenesSeleccionadas.length >= 4">
                        <i class="fas fa-cloud-upload-alt me-2"></i>
                        {{ imagenesSeleccionadas.length > 0 ? 'Agregar Más Imágenes' : 'Seleccionar Imágenes' }}
                    </button>

                    <div class="text-muted small">
                        <i class="fas fa-info-circle me-1"></i>
                        Máximo 4 imágenes | Tamaño máximo: 2MB cada una | Formatos: JPG, PNG, GIF, WEBP
                    </div>

                    <div *ngIf="imagenesSeleccionadas.length >= 4" class="text-warning small mt-2">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        Límite de imágenes alcanzado
                    </div>
                </div>
            </div>
        </div>

        <!-- Vista previa de imágenes seleccionadas -->
        <div *ngIf="imagenesSeleccionadas.length > 0" class="mt-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="text-dark fw-semibold mb-0">
                    <i class="fas fa-images text-primary me-2"></i>
                    Imágenes Adjuntas ({{imagenesSeleccionadas.length}}/4)
                </h6>
                <span class="badge bg-primary">{{ imagenesSeleccionadas.length }} archivo(s)</span>
            </div>

            <div class="row g-3">
                <div *ngFor="let img of imagenesSeleccionadas; let i = index" class="col-6 col-md-3">
                    <div class="card border-0 shadow-sm h-100 hover-card" style="transition: transform 0.2s;">
                        <div class="position-relative">
                            <img [src]="img.preview" class="card-img-top" style="height: 150px; object-fit: cover;"
                                [alt]="img.nombre">

                            <button type="button" class="btn btn-danger btn-sm rounded-circle position-absolute"
                                (click)="eliminarImagenSeleccionada(i)"
                                style="top: 8px; right: 8px; width: 32px; height: 32px; padding: 0; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"
                                title="Eliminar imagen">
                                <i class="fas fa-times"></i>
                            </button>

                            <div class="position-absolute bottom-0 start-0 end-0 bg-dark bg-opacity-75 text-white p-1"
                                style="font-size: 0.7rem;">
                                <i class="fas fa-file-image me-1"></i>{{ formatearTamano(img.tamano) }}
                            </div>
                        </div>

                        <div class="card-body p-2">
                            <small class="d-block text-truncate text-muted" [title]="img.nombre">
                                {{ img.nombre }}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error Alert -->
        <div class="alert alert-danger border-0 shadow-sm d-flex align-items-start mt-3" role="alert" *ngIf="error">
            <i class="fas fa-exclamation-circle me-3 mt-1" style="font-size: 1.5rem;"></i>
            <div>
                <strong class="d-block mb-1">Error de Validación</strong>
                <div>{{ error }}</div>
            </div>
        </div>
    </div>

    <div class="modal-footer border-0 bg-light" style="padding: 1.25rem 1.5rem;">
        <button type="button" class="btn btn-lg btn-outline-secondary px-4" (click)="cancelar()" [disabled]="guardando">
            <i class="fas fa-times me-2"></i>
            Cancelar
        </button>

        <button type="button" class="btn btn-lg px-5 shadow" [class.btn-primary]="!guardando"
            [class.btn-secondary]="guardando" (click)="guardar()" [disabled]="guardando || !actividadSeleccionada"
            style="min-width: 180px;">
            <span *ngIf="guardando">
                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                Guardando...
            </span>
            <span *ngIf="!guardando">
                <i class="fas fa-check-circle me-2"></i>
                Registrar Cumplimiento
            </span>
        </button>
    </div>
</div>

<style>
    .hover-card:hover {
        transform: translateY(-4px);
    }

    .modal-body::-webkit-scrollbar {
        width: 8px;
    }

    .modal-body::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    .modal-body::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
    }

    .modal-body::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    .border-dashed {
        border-style: dashed !important;
    }
</style>