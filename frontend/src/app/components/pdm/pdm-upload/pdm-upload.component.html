<div class="pdm-upload-container">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="mb-1"><i class="fas fa-cloud-upload-alt me-2 text-primary"></i>Carga de Plan de Desarrollo
                Municipal</h3>
            <p class="text-muted mb-0 small">Sube tu archivo Excel con el PDM para analizar metas y cumplimiento</p>
        </div>
    </div>

    <!-- Info del Excel en Base de Datos -->
    @if (excelEnBD().existe) {
    <div class="row mb-4">
        <div class="col">
            <div class="card shadow-sm border-primary">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <i class="fas fa-database fa-3x text-primary"></i>
                        </div>
                        <div class="col">
                            <h4 class="mb-1">
                                <i class="fas fa-file-excel me-2"></i>
                                Excel almacenado en base de datos
                            </h4>
                            <p class="text-muted mb-2">
                                <strong>Archivo:</strong> {{ excelEnBD().nombre }}
                                <span class="badge bg-secondary ms-2">{{ formatBytes(excelEnBD().tamanio!) }}</span>
                            </p>
                            <p class="text-muted mb-0">
                                <strong>Fecha de carga:</strong> <span class="badge bg-info">{{
                                    formatDate(excelEnBD().fecha!) }}</span>
                            </p>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-success me-2" (click)="cargarDesdeBaseDatos()"
                                [disabled]="cargando()">
                                <i class="fas fa-download me-2"></i>Cargar para Análisis
                            </button>
                            <button class="btn btn-outline-danger" (click)="limpiarDatos()">
                                <i class="fas fa-trash me-2"></i>Eliminar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    }

    <!-- Info del caché -->
    @if (tieneDatos()) {
    <div class="row mb-4">
        <div class="col">
            <div class="card shadow-sm border-success">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-3x text-success"></i>
                        </div>
                        <div class="col">
                            <h4 class="mb-1">
                                <i class="fas fa-memory me-2"></i>
                                Datos en caché local
                            </h4>
                            <p class="text-muted mb-2">
                                Última carga: <span class="badge bg-info">{{ formatDate(cacheInfo().fecha!) }}</span>
                            </p>
                            <p class="mb-0 small">Los datos del PDM están listos para análisis. Puedes ir directamente
                                al
                                dashboard.</p>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-primary me-2" (click)="irAlDashboard()">
                                <i class="fas fa-chart-line me-2"></i>Ir al Dashboard
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    }

    @if (excelEnBD().existe || tieneDatos()) {
    <hr class="my-4">

    <div class="text-center mb-4">
        <h5 class="text-muted">
            <i class="fas fa-sync-alt me-2"></i>
            O actualiza los datos cargando un nuevo archivo
        </h5>
    </div>
    }

    <!-- Upload Zone -->
    <div class="row mb-4">
        <div class="col">
            <div class="card shadow-sm border-0">
                <div class="card-body p-5">
                    <div class="drop-zone border-3 border-dashed rounded-4 p-5 text-center"
                        [class.border-primary]="dragOver()" [class.bg-primary-subtle]="dragOver()"
                        [class.border-success]="archivoCargado()" [class.bg-success-subtle]="archivoCargado()"
                        (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)" (drop)="onDrop($event)">

                        @if (!archivoCargado()) {
                        <!-- Estado inicial -->
                        <i class="fas fa-file-excel fa-5x text-primary mb-4"></i>
                        <h3 class="mb-3">Arrastra tu archivo Excel aquí</h3>
                        <p class="text-muted mb-4">o haz clic para seleccionar</p>

                        <input type="file" #fileInput accept=".xlsx,.xls" (change)="onFileSelected($event)" hidden>

                        <button class="btn btn-primary btn-lg mb-4" (click)="fileInput.click()">
                            <i class="fas fa-folder-open me-2"></i>
                            Seleccionar Archivo
                        </button>

                        <div class="row justify-content-center mb-4">
                            <div class="col-auto">
                                <span class="badge bg-success fs-6 py-2 px-3">
                                    <i class="fas fa-check me-2"></i>Formato: .xlsx, .xls
                                </span>
                            </div>
                            <div class="col-auto">
                                <span class="badge bg-success fs-6 py-2 px-3">
                                    <i class="fas fa-check me-2"></i>Tamaño máximo: 10 MB
                                </span>
                            </div>
                        </div>

                        <div class="alert alert-light">
                            <h6 class="alert-heading">
                                <i class="fas fa-info-circle me-2"></i>
                                Hojas requeridas en el Excel:
                            </h6>
                            <ul class="list-unstyled mb-0 text-start">
                                <li><i class="fas fa-check-circle text-success me-2"></i>Líneas estratégicas</li>
                                <li><i class="fas fa-check-circle text-success me-2"></i>Indicadores de resultado</li>
                                <li><i class="fas fa-check-circle text-success me-2"></i>Plan indicativo - Productos
                                </li>
                                <li><i class="fas fa-check-circle text-success me-2"></i>Iniciativas SGR</li>
                                <li><i class="fas fa-check-circle text-success me-2"></i>Plan indicativo SGR - Produc
                                </li>
                            </ul>
                        </div>
                        } @else {
                        <!-- Archivo seleccionado -->
                        <i class="fas fa-file-check fa-5x text-success mb-4"></i>
                        <h3 class="mb-3">{{ archivoCargado()!.name }}</h3>
                        <div class="d-flex justify-content-center gap-3 mb-3">
                            <span class="badge bg-secondary fs-6 py-2 px-3">
                                <i class="fas fa-weight me-2"></i>{{ formatBytes(archivoCargado()!.size) }}
                            </span>
                            <span class="badge bg-secondary fs-6 py-2 px-3">
                                <i class="fas fa-calendar me-2"></i>{{ formatDate(archivoCargado()!.lastModified) }}
                            </span>
                        </div>
                        }
                    </div>

                    <!-- Progress Bar -->
                    @if (cargando()) {
                    <div class="mt-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <span class="fw-bold">Procesando archivo...</span>
                            </div>
                            <span class="badge bg-primary fs-6">{{ progreso() }}%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                                role="progressbar" [style.width.%]="progreso()">
                            </div>
                        </div>
                    </div>
                    }

                    <!-- Actions -->
                    @if (archivoCargado() && !cargando()) {
                    <div class="d-flex justify-content-center gap-3 mt-4">
                        <button class="btn btn-primary btn-lg" (click)="procesarArchivo()" [disabled]="cargando()">
                            <i class="fas fa-chart-bar me-2"></i>
                            Procesar y Analizar
                        </button>
                        <button class="btn btn-outline-secondary btn-lg"
                            (click)="archivoCargado.set(null); archivoSeleccionado = null">
                            <i class="fas fa-times me-2"></i>
                            Cambiar Archivo
                        </button>
                    </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Help Section -->
    <div class="row">
        <div class="col">
            <div class="alert alert-info d-flex align-items-start">
                <i class="fas fa-question-circle fa-2x me-3"></i>
                <div>
                    <h5 class="alert-heading">¿Cómo funciona?</h5>
                    <ul class="mb-0">
                        <li><strong>Primera vez:</strong> Sube tu archivo Excel. Se guardará en la base de datos y se
                            procesará para análisis.</li>
                        <li><strong>Análisis y seguimiento:</strong> Usa el botón "Cargar para Análisis" para descargar
                            el Excel de la BD y procesarlo localmente.</li>
                        <li><strong>Actualización:</strong> Puedes cargar un nuevo archivo en cualquier momento. El
                            anterior será reemplazado.</li>
                    </ul>
                    <p class="mb-0 mt-2"><small>Asegúrate de que tu archivo Excel contenga las 5 hojas requeridas con la
                            estructura
                            estándar del Plan de Desarrollo Municipal (PDM).</small></p>
                </div>
            </div>
        </div>
    </div>
</div>